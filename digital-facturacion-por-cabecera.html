<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIGITAL - An√°lisis por SITE</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root {
  --primary-brand: #38bdf8;
  --secondary-brand: #f59e0b;
  --accent-print: #db2777;
  --success: #34d399;
  --danger: #f87171;
  --neutral-gray: #4b5563;
  --bg-dark: #020617;
  --card-bg: #111827;
  --text-main: #e5e7eb;
  --comp: var(--primary-brand);
  --base: var(--secondary-brand);
  --neg: var(--danger);
  --diffColor: #6ee7b7;
  --ok-green: var(--success);
  --totalBg: #1e40af;
  --estimate-bg: #4c1d95; 
  --siteBg: #fef3c7;
  --productoBg: #dbeafe;
  --sectorBg: #fbcfe8;
  --areaBg: #fcd5ce;
  --anuncianteBg: #e9d5ff;
  --title-mes: var(--accent-print);
  --title-site: var(--accent-print);
  --title-producto: var(--accent-print);
  --title-comercial: var(--accent-print);
  --title-marca: var(--accent-print);
  --title-familia: var(--accent-print);
  --bullet-size: 1.1rem;
  --bullet-indent: 22px;
  --summary-bg: var(--card-bg);
  --summary-border: var(--neutral-gray);
}

body { margin: 0; font-family: 'Inter', Arial, sans-serif; background: linear-gradient(180deg, var(--bg-dark), #0f172a); color: var(--text-main); overflow-y: scroll; }
h1 { text-align: center; font-size: 1.5rem; margin: 20px 0; }
.container{ max-width:1500px; margin:auto; padding:20px; }
.card{ background:rgba(17,24,39,.9); border-radius:14px; padding:18px; margin-bottom:20px; border: 1px solid #1f2937; }
.label-style { font-size: 0.95em; font-weight: bold; margin-bottom: 8px; display: block; }
.filters select, input[type=file]{ background:#1f2933; color:var(--text-main); border:1px solid #374151; padding:8px 10px; border-radius:8px; width: 100%; box-sizing: border-box; }
#loadStatus { margin-top: 10px; font-weight: 600; font-size: 0.85em; }
.filters label{ font-weight:600; margin-right:6px; display:block; margin-top:10px; }
.filtersRow{ display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start; }
.filtersRow div select{ width:210px; font-weight:600; }
#fSite{ background:var(--siteBg); color:#111; }
#fProduct{ background:var(--productoBg); color:#111; }
#fSector{ background:var(--sectorBg); color:#111; }
#fArea{ background:var(--areaBg); color:#111; }
#fAnunciante{ background:var(--anuncianteBg); color:#111; }
.checkboxGroup{ display:flex; flex-wrap:wrap; gap:10px; margin-top:5px; }
.checkboxGroup label{ font-size: 0.85em; font-weight:400; color: #cbd5e1; display: flex; align-items: center; gap: 4px; cursor: pointer; }
.totalBlock{ background:var(--totalBg); padding:15px; border-radius:12px; margin-top:10px; }
.totalValues{ display:flex; justify-content:space-around; font-size:18px; }
.totalValues div{text-align:center;}
.totalValues .value{ font-size:22px; font-weight:700; display: block; margin-top: 5px; }
#diffPercent.negative{ color:var(--neg); }
.statsBlock{ display:flex; justify-content:center; border-radius:12px; margin:20px 0; gap:10px; flex-wrap:wrap; }
.subBlock{ border-radius:12px; padding:20px; display:flex; align-items:center; justify-content:center; }
.statsBase{ flex:0 0 450px; background:var(--comp); color:#111; }
.statsDiff{ flex:0 0 300px; background:var(--diffColor); color:#111; }
.statsComp{ flex:0 0 450px; background:var(--base); color:#111; }
.statsValues{ display:flex; justify-content:center; font-size:16px; gap:18px; flex-wrap:wrap; }
.statsValues div{text-align:center;}
.statsValues .value{ font-size:18px; font-weight:700; display:block; margin-top:5px; }
.statsDiff .value.negative{ color:var(--neg); }
.summaryCard{ border:1px solid var(--summary-border); background:var(--summary-bg); border-radius:12px; padding:18px; color:#cbd5e1; }
.summaryCard h2{ margin:0 0 14px 0; font-size:1.15em; color:#fff; }
.summaryGrid{ display:grid; grid-template-columns:repeat(2,minmax(280px,1fr)); gap:18px; }
.summaryHeader{ font-weight:800; color:#fff; border:1px solid #1f2937; border-radius:10px; padding:10px 12px; background:rgba(17,24,39,0.6); }
.summarySection{ background:rgba(2,6,23,0.35); border:1px solid rgba(75,85,99,0.5); border-radius:12px; padding:12px 12px 6px 12px; min-height: 100px; }
.summaryTitle{ font-weight:800; margin:4px 0 10px 0; }
.summaryTitle.mes{ color:var(--title-mes); }
.summaryTitle.site{ color:var(--title-site); }
.summaryTitle.producto{ color:var(--title-producto); }
.summaryTitle.comercial{ color:var(--title-comercial); }
.summaryTitle.marca{ color:var(--title-marca); }
.summaryTitle.familia{ color:var(--title-familia); }
.itemList { list-style:none; padding:0; margin:0 0 8px 0; }
.itemList li { position:relative; padding-left: var(--bullet-indent); margin:8px 0; color:#e5e7eb; font-weight:400; line-height:1.35; min-height: 1.5rem; }
.itemList li::before{ content:"‚úî"; font-size:var(--bullet-size); position:absolute; left:0; top:0.1rem; }
.itemList li.empty-item::before { content: ""; }
.itemList li.empty-item { color: transparent; }
.itemList .amount{ font-variant-numeric: tabular-nums; font-weight: 700;}
.itemList .pct.neg{ color:var(--neg); }
.itemList .pct.pos{ color:var(--ok-green); }
.toggleBtn{ margin-top:8px; background:#1f2937; color:#e5e7eb; border:1px solid #374151; padding:8px 10px; border-radius:8px; cursor:pointer; width: 100%; }
.toggleBtn:hover{ background:#374151; }

.chart-legend { display: flex; gap: 20px; margin-bottom: 15px; font-size: 0.9em; font-weight: bold; }
.legend-item { display: flex; align-items: center; gap: 8px; }
.dot-base { width: 14px; height: 14px; background: var(--comp); border-radius: 4px; box-shadow: 0 0 8px var(--comp); }
.dot-comp { width: 14px; height: 14px; background: var(--base); border-radius: 4px; box-shadow: 0 0 8px var(--base); }

.chart-footer-note {
  margin-top: 15px;
  padding: 10px;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 8px;
  font-size: 0.8rem;
  color: #94a3b8;
  border-left: 3px solid var(--accent-print);
  display: flex;
  align-items: center;
  gap: 10px;
}

/* BLOQUE DE ESTIMACI√ìN NUEVO */
.estimateCard {

/* Va de un verde oscuro a un azul profundo */
    background: linear-gradient(135deg, #064e3b 0%, #1e3a8a 100%);
    border: 2px solid #34d399; 
    /* ... resto de propiedades ... */

    box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
    margin-top: 30px;
    padding: 25px;
    border-radius: 18px;
    color: #f3f4f6;
    max-width: 1200px;  /* Controla el ancho m√°ximo */
    margin-left: auto; /* Centra el bloque */
    margin-right: auto;/* Centra el bloque */
}
.estimateTitle {
    font-size: 1.4rem;
    font-weight: 800;
    margin-bottom: 20px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
}
.estimateGrid {
    display: flex;
    justify-content: space-around;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}
.estimateBox {
    background: rgba(0,0,0,0.3);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    flex: 1;
    min-width: 250px;
}
.estimateBox span { display: block; font-size: 0.9rem; color: #c4b5fd; margin-bottom: 5px; }
.estimateBox .estValue { font-size: 2rem; font-weight: 900; color: #fff; }

/* Tabla de desglose */
.estimateTable {
    width: 100%;
    margin-top: 25px;
    border-collapse: collapse;
    font-size: 0.85rem;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    overflow: hidden;
}
.estimateTable th { background: rgba(139, 92, 246, 0.5); padding: 12px; text-align: left; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
.estimateTable td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.estimateTable tr:last-child { font-weight: bold; background: rgba(255,255,255,0.15); color: #fff; font-size: 1rem; }

/* Badge de porcentaje */
.pct-badge { 
    font-weight: 800; 
    margin-left: 15px; 
    font-size: 1.4rem; 
    padding: 4px 12px; 
    border-radius: 8px; 
    background: rgba(0,0,0,0.3);
    display: inline-block;
}
.pct-pos { color: #34d399; border: 1px solid #34d399; }
.pct-neg { color: #f87171; border: 1px solid #f87171; }

.mini-charts-grid { grid-column: 1 / span 2; display: flex; flex-direction: column; gap: 15px; margin: 10px 0; }
.mini-charts-row { display: grid; gap: 10px; }
.row-3-col { grid-template-columns: repeat(3, 1fr); }
.row-2-col { grid-template-columns: repeat(2, 1fr); }
.mini-chart-box { background: rgba(15, 23, 42, 0.5); border: 1px solid #334155; border-radius: 10px; padding: 10px; text-align: center; }
.mini-chart-box h4 { margin: 0 0 8px 0; font-size: 0.85rem; color: var(--accent-print); text-transform: uppercase; }
.mini-canvas { width: 100%; height: 140px; }

.lock-overlay { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 10px; }
.lock-btn { background: var(--accent-print); color: white; border: none; padding: 6px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
.pass-input { background:#1f2933; color:var(--text-main); border:1px solid #374151; padding:6px; border-radius:6px; text-align:center; }
</style>
</head>

<body>
<h1>DIGITAL - An√°lisis por SITE</h1>
<div class="container">
  <div class="card">
    <label class="label-style">Cargar datos (Excel):</label>
    <input type="file" id="fileInput" accept=".json,.xlsx">
    <div id="loadStatus">Esperando archivo...</div>
  </div>

  <div id="filters" class="card filters" style="display:none">
    <div class="filtersRow">
      <div>
        <label class="labelBase" style="color:var(--comp);">A√±o base</label>
        <select id="fYear"></select>
        <div class="checkboxGroup" id="monthsBase"></div>
      </div>
      <div>
        <label class="labelComp" style="color:var(--base);">A√±o comparaci√≥n</label>
        <select id="fYear2"></select>
        <div class="checkboxGroup" id="monthsComp"></div>
      </div>
    </div>
  </div>

  <div id="siteOnlyBlock" class="card filters" style="display:none">
    <div class="filtersRow">
      <div><label>Site a Analizar...</label><select id="fSite"></select></div>
    </div>
  </div>

  <div id="mainFiltersBlock" class="card filters" style="display:none">
    <div class="filtersRow">
      <div><label>Producto</label><select id="fProduct"></select></div>
      <div><label>Sector</label><select id="fSector"></select></div>
      <div><label>√Årea</label><select id="fArea"></select></div>
      <div><label>Anunciante (Por Volumen)</label><select id="fAnunciante"></select></div>
    </div>
  </div>

  <div id="totalBlock" class="card" style="display:none">
    <div class="totalBlock">
      <div class="totalValues">
        <div>A√±o base<div id="totalYear1" class="value">0‚Ç¨</div></div>
        <div>A√±o comparaci√≥n<div id="totalYear2" class="value">-</div></div>
        <div>% diferencia<div id="diffPercent" class="value">-</div></div>
      </div>
    </div>
  </div>

  <div id="statsBlock" class="statsBlock" style="display:none">
    <div class="subBlock statsBase">
      <div class="statsValues">
        <div>Fact. A√±o Base<div id="totalStatsBase" class="value">0‚Ç¨</div></div>
        <div>N¬∫ l√≠neas<div id="linesStatsBase" class="value">0</div></div>
        <div>Presupuesto medio<div id="avgStatsBase" class="value">0‚Ç¨</div></div>
      </div>
    </div>
    <div class="subBlock statsDiff">
      <div class="statsValues">
        <div>% Crec. Presup. Medio<div id="diffAvgStats" class="value">0%</div></div>
      </div>
    </div>
    <div class="subBlock statsComp">
      <div class="statsValues">
        <div>Fact. A√±o Comparaci√≥n<div id="totalStatsComp" class="value">-</div></div>
        <div>N¬∫ l√≠neas<div id="linesStatsComp" class="value">0</div></div>
        <div>Presupuesto medio<div id="avgStatsComp" class="value">-</div></div>
      </div>
    </div>
  </div>

  <div id="advSummaryCard" class="summaryCard" style="display:none">
    <h2>Resumen</h2>
    <div class="summaryGrid">
      <div class="summaryHeader" style="background:var(--comp); color:#111;">A√±o base: <span id="summaryYearBase">‚Äî</span></div>
      <div class="summaryHeader" style="background:var(--base); color:#111;">A√±o comparaci√≥n: <span id="summaryYearComp">‚Äî</span></div>
      
      <div class="summarySection">
        <div class="summaryTitle mes">Mes</div>
        <ul id="advMonthsBase" class="itemList mes"></ul>
      </div>
      <div class="summarySection">
        <div class="summaryTitle mes">Mes</div>
        <ul id="advMonthsComp" class="itemList mes"></ul>
      </div>

      <div class="summarySection" style="grid-column: 1 / span 2; padding: 15px;">
        <div class="summaryTitle mes" style="margin-bottom: 10px;">Evoluci√≥n mensual (Base vs Comparaci√≥n)</div>
        <div class="chart-legend">
           <div class="legend-item"><div class="dot-base"></div> <span id="legBase">Base</span></div>
           <div id="legCompGroup" class="legend-item" style="display:none"><div class="dot-comp"></div> <span id="legComp">Comp</span></div>
        </div>
        <canvas id="monthsChart" style="width:100%; height:320px; display:block;"></canvas>
        <div class="chart-footer-note">
          <span>‚ÑπÔ∏è</span>
          <span><strong>Interpretaci√≥n de Tendencia:</strong> Un posicionamiento de la curva <strong>Azul (A√±o Base)</strong> por encima de la <strong>Amarilla (A√±o Comparado)</strong> indica crecimiento interanual positivo. Inversamente, si la curva amarilla predomina, se identifica una desviaci√≥n negativa respecto al periodo anterior.</span>
        </div>
      </div>

      <div class="summarySection">
        <div class="summaryTitle marca">Marca</div>
        <ul id="advBrandsBase" class="itemList marca"></ul>
        <button id="brandsToggleBtn" class="toggleBtn" style="display:none">Ver m√°s marcas</button>
      </div>
      <div class="summarySection">
        <div class="summaryTitle marca">Marca</div>
        <ul id="advBrandsComp" class="itemList marca"></ul>
      </div>

      <div class="summarySection">
        <div class="summaryTitle familia">Familias</div>
        <ul id="advFamiliesBase" class="itemList familia"></ul>
      </div>
      <div class="summarySection">
        <div class="summaryTitle familia">Familias</div>
        <ul id="advFamiliesComp" class="itemList familia"></ul>
      </div>

      <div class="mini-charts-grid">
        <div class="mini-charts-row row-3-col">
          <div class="mini-chart-box"><h4>Sponsorship</h4><canvas id="chartSpons" class="mini-canvas"></canvas></div>
          <div class="mini-chart-box"><h4>Social Networks</h4><canvas id="chartSocial" class="mini-canvas"></canvas></div>
          <div class="mini-chart-box"><h4>Curated</h4><canvas id="chartCurated" class="mini-canvas"></canvas></div>
        </div>
        <div class="mini-charts-row row-2-col">
          <div class="mini-chart-box"><h4>Display + Video</h4><canvas id="chartDisplay" class="mini-canvas"></canvas></div>
          <div class="mini-chart-box"><h4>Program√°tica</h4><canvas id="chartProg" class="mini-canvas"></canvas></div>
        </div>
       <div class="chart-footer-note">
          <span>‚ÑπÔ∏è</span>
          <span><strong>Interpretaci√≥n de Tendencia:</strong> Un posicionamiento de la curva <strong>Azul (A√±o Base)</strong> por encima de la <strong>Amarilla (A√±o Comparado)</strong> indica crecimiento interanual positivo. Inversamente, si la curva amarilla predomina, se identifica una desviaci√≥n negativa respecto al periodo anterior.</span>
        </div>
      </div>

      <div class="summarySection">
        <div class="summaryTitle producto">Producto</div>
        <ul id="advProductsBase" class="itemList producto"></ul>
      </div>
      <div class="summarySection">
        <div class="summaryTitle producto">Producto</div>
        <ul id="advProductsComp" class="itemList producto"></ul>
      </div>

      <div class="summarySection">
        <div class="summaryTitle comercial">Comercial</div>
        <div id="lockComercial" class="lock-overlay">
          <input type="password" id="passInput" class="pass-input" placeholder="Contrase√±a...">
          <button class="lock-btn" onclick="checkPass()">Desbloquear</button>
        </div>
        <ul id="advSalesBase" class="itemList comercial" style="display:none"></ul>
      </div>
      <div class="summarySection">
        <div class="summaryTitle comercial">Comercial</div>
        <ul id="advSalesComp" class="itemList comercial" style="display:none"></ul>
      </div>
    </div>

    <div id="estimateBlock" class="estimateCard" style="display:none">
      <div class="estimateTitle">Proyecci√≥n de Cierre de Ejercicio <span id="estYearLabel"></span></div>
      <div class="estimateGrid">
        <div class="estimateBox">
          <span>Facturaci√≥n Real a hoy (2026)</span>
          <div id="valRealHoy" class="estValue">0‚Ç¨</div>
        </div>
        <div class="estimateBox">
          <span>Estimaci√≥n Cierre 31 Dic</span>
          <div style="display: flex; align-items: center; justify-content: center;">
            <div id="valEstFinal" class="estValue">0‚Ç¨</div>
            <span id="valEstPct" class="pct-badge"></span>
          </div>
        </div>
      </div>

      <table class="estimateTable">
        <thead>
          <tr>
            <th>Mes</th>
            <th>M√©todo de C√°lculo</th>
            <th>Estimaci√≥n Mes</th>
          </tr>
        </thead>
        <tbody id="estimateTableBody"></tbody>
      </table>

      <div class="chart-footer-note" style="border-left-color: #a78bfa; margin-top:20px;">
        <span>üîÆ</span>
        <span><strong>Nota de C√°lculo:</strong> 1) Meses cerrados: Real 2026. 2) Mes curso: Proyecci√≥n lineal + Program√°tica 2025. 3) Meses futuros: Real 2025 + 3%. Comparativa (%) contra cierre total del a√±o anterior para los mismos filtros.</span>
      </div>
    </div>

  </div>
</div>

<script>
const excelUrl = "PRODUCCION%20DIGITAL.xlsx";
const MONTHS = ["01 Enero","02 Febrero","03 Marzo","04 Abril","05 Mayo","06 Junio","07 Julio","08 Agosto","09 Septiembre","10 Octubre","11 Noviembre","12 Diciembre"];
const MONTH_INITIALS = ["E", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D"];
let rawData = [];
let isUnlocked = false;

function checkPass() {
    if(document.getElementById('passInput').value === "mascara") {
        isUnlocked = true;
        document.getElementById('lockComercial').style.display = 'none';
        document.getElementById('advSalesBase').style.display = 'block';
        document.getElementById('advSalesComp').style.display = 'block';
        render();
    } else { alert("Contrase√±a incorrecta"); }
}

window.addEventListener("DOMContentLoaded", () => {
  const statusEl = document.getElementById("loadStatus");
  fetch(excelUrl)
    .then(resp => resp.ok ? resp.arrayBuffer() : Promise.reject())
    .then(buf => {
      const wb = XLSX.read(buf, { type: "array" });
      init(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" }));
      statusEl.innerText = "‚úÖ Archivo cargado autom√°ticamente";
      statusEl.style.color = "var(--ok-green)";
    })
    .catch(() => { statusEl.innerText = "‚ö†Ô∏è Selecciona el Excel manualmente."; });
});

function toTitleCase(str) { if(!str) return ""; return str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); }
function cleanSector(str) { if(!str) return ""; return toTitleCase(str.replace(/^[0-9* ]+/, "")); }
function num(v){ if(v==null) return 0; if(typeof v === 'number') return v; const s = String(v).replace(/\u00A0/g," ").replace(/‚Ç¨/g,"").replace(/\s/g,"").replace(/\./g,"").replace(/,/g,"."); const n = Number(s); return Number.isFinite(n) ? n : 0; }
const currencyFormatter = new Intl.NumberFormat('es-ES', { useGrouping: true, minimumFractionDigits: 0, maximumFractionDigits: 0 });
function formatCurrency(n){ return currencyFormatter.format(Math.round(n||0))+'‚Ç¨'; }
function formatInteger(n){ return new Intl.NumberFormat('es-ES').format(Math.round(n||0)); }

fileInput.onchange = e => {
  const f = e.target.files[0];
  const r = new FileReader();
  r.onload = ev => {
    const data = new Uint8Array(ev.target.result);
    const wb = XLSX.read(data, {type:"array"});
    init(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" }));
    document.getElementById("loadStatus").innerText = "‚úÖ Archivo cargado";
  };
  r.readAsArrayBuffer(f);
};

function init(data){
  rawData = data.map(d => ({
    ingreso: num(d["Imp.Neto a Comisionar"]),
    A√±o: String(d["A√±o inserci√≥n"] || "").trim(),
    Mes: MONTHS.find(m => m.startsWith(String(d["Mes inserci√≥n"]).trim().substring(0,2))) || "",
    Site: String(d["Publicaci√≥n"] || "").trim().toLowerCase(),
    Product: toTitleCase(String(d["Producto"] || "").trim()),
    Sector: cleanSector(String(d["Sector"] || "")),
    Comercial: toTitleCase(String(d["Comercial"] || "").trim()),
    Area: toTitleCase(String(d["√ÅREAS"] || "").trim()),
    Anunciante: String(d["Anunciante"] || "SIN ANUNCIANTE").trim().toUpperCase(),
    Marca: toTitleCase(String(d["Marca"] || "").trim()),
    Familia: toTitleCase(String(d["Familia"] || "").trim())
  })).filter(d => d.A√±o !== "");

  const populate = (id, arr) => {
    const el = document.getElementById(id);
    if(!el) return;
    el.innerHTML = "<option>Todos</option>" + [...new Set(arr.filter(Boolean))].sort().map(v=>`<option>${v}</option>`).join("");
  };

  const advSums = {};
  rawData.forEach(d => { if(d.Anunciante) advSums[d.Anunciante] = (advSums[d.Anunciante] || 0) + d.ingreso; });
  const sortedAdvs = Object.keys(advSums).sort((a,b) => advSums[b] - advSums[a]);
  fAnunciante.innerHTML = "<option>Todos</option>" + sortedAdvs.map(v => `<option>${v}</option>`).join("");

  populate("fSite", rawData.map(d=>d.Site));
  populate("fProduct", rawData.map(d=>d.Product));
  populate("fSector", rawData.map(d=>d.Sector));
  populate("fArea", rawData.map(d=>d.Area));

  const years = [...new Set(rawData.map(d=>d.A√±o))].sort().reverse();
  fYear.innerHTML = "<option>Todos</option>" + years.map(y=>`<option>${y}</option>`).join("");
  fYear2.innerHTML = "<option>Sin comparar</option>" + years.map(y=>`<option>${y}</option>`).join("");

  document.getElementById("monthsBase").innerHTML = MONTHS.map(m=>`<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");
  document.getElementById("monthsComp").innerHTML = MONTHS.map(m=>`<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");

  [fAnunciante,fSite,fProduct,fSector,fYear,fYear2,fArea].forEach(el=>{ if(el) el.onchange=render; });
  ["mainFiltersBlock","siteOnlyBlock","filters","totalBlock","advSummaryCard","estimateBlock"].forEach(id=>document.getElementById(id).style.display="block");
  document.getElementById("statsBlock").style.display="flex";
  render();
}

function calcNetting(data) {
  const totalFact = data.reduce((acc, b) => acc + b.ingreso, 0);
  const groups = {};
  data.forEach(d => { if (!groups[d.Anunciante]) groups[d.Anunciante] = []; groups[d.Anunciante].push(d.ingreso); });
  let lines = 0;
  Object.values(groups).forEach(pool => {
    let filteredPool = pool.filter(v => v !== 0).sort((a, b) => Math.abs(a) - Math.abs(b));
    while (filteredPool.length > 0) {
      let cur = filteredPool.shift();
      let idx = filteredPool.findIndex(v => v === -cur);
      if (idx !== -1) filteredPool.splice(idx, 1);
      else if (cur > 0) lines++;
    }
  });
  return { total: totalFact, lines, avg: lines ? totalFact / lines : 0 };
}

function groupSumGeneric(data, keyField) {
  const map = new Map();
  data.forEach(d => { const k = d[keyField] || "Desconocido"; map.set(k, (map.get(k) || 0) + d.ingreso); });
  return Array.from(map.entries()).map(([label, sum]) => ({ label, sum })).sort((a,b) => b.sum - a.sum);
}

function groupSumMonths(data) {
  const map = new Map();
  data.forEach(d => { if(d.Mes) map.set(d.Mes, (map.get(d.Mes) || 0) + d.ingreso); });
  return MONTHS.map(m => ({ label: m.slice(3), sum: map.get(m) || 0 }));
}

function fillMirrorLists(idBase, idComp, itemsBase, itemsComp, isMonth = false) {
  const ulBase = document.getElementById(idBase);
  const ulComp = document.getElementById(idComp);
  ulBase.innerHTML = ""; ulComp.innerHTML = "";
  const allLabels = isMonth ? MONTHS.map(m => m.slice(3)) : [...new Set([...itemsBase.map(i => i.label), ...itemsComp.map(i => i.label)])];
  allLabels.forEach(label => {
    const dataBase = itemsBase.find(i => i.label === label);
    const dataComp = itemsComp.find(i => i.label === label);
    if(!isMonth && !dataBase && !dataComp) return;
    const liB = document.createElement('li');
    if (dataBase) {
      let content = `${dataBase.label} ‚Äî <span class="amount">${formatCurrency(dataBase.sum)}</span>`;
      if (dataComp && dataComp.sum > 0) {
        const pct = Math.round(((dataBase.sum / dataComp.sum) - 1) * 100);
        content += ` ‚Äî <span class="pct ${pct < 0 ? 'neg' : 'pos'}">${pct > 0 ? '+' : ''}${pct}%</span>`;
      }
      liB.innerHTML = content;
    } else { liB.className = "empty-item"; liB.innerHTML = `${label} ‚Äî 0‚Ç¨`; }
    ulBase.appendChild(liB);
    const liC = document.createElement('li');
    if (dataComp) liC.innerHTML = `${dataComp.label} ‚Äî <span class="amount">${formatCurrency(dataComp.sum)}</span>`;
    else { liC.className = "empty-item"; liC.innerHTML = `${label} ‚Äî 0‚Ç¨`; }
    ulComp.appendChild(liC);
  });
}

let currentBrandsLimit = 25;
function fillBrandsMirrorWithLimit(idBase, idComp, itemsBase, itemsComp) {
  const ulBase = document.getElementById(idBase);
  const ulComp = document.getElementById(idComp);
  const btn = document.getElementById('brandsToggleBtn');
  ulBase.innerHTML = ""; ulComp.innerHTML = "";
  const baseLabels = itemsBase.map(i => i.label);
  baseLabels.forEach((label, idx) => {
    const dataBase = itemsBase.find(i => i.label === label);
    const dataComp = itemsComp.find(i => i.label === label);
    const liB = document.createElement('li');
    let contentB = `${dataBase.label} ‚Äî <span class="amount">${formatCurrency(dataBase.sum)}</span>`;
    if (dataComp && dataComp.sum > 0) {
      const pct = Math.round(((dataBase.sum / dataComp.sum) - 1) * 100);
      contentB += ` ‚Äî <span class="pct ${pct < 0 ? 'neg' : 'pos'}">${pct > 0 ? '+' : ''}${pct}%</span>`;
    }
    liB.innerHTML = contentB;
    const liC = document.createElement('li');
    if (dataComp) liC.innerHTML = `${dataComp.label} ‚Äî <span class="amount">${formatCurrency(dataComp.sum)}</span>`;
    else { liC.className = "empty-item"; liC.innerHTML = `${label} ‚Äî 0‚Ç¨`; }
    if (idx >= currentBrandsLimit) { liB.style.display = 'none'; liC.style.display = 'none'; }
    ulBase.appendChild(liB); ulComp.appendChild(liC);
  });
  if (baseLabels.length > currentBrandsLimit) {
    btn.style.display = 'block';
    btn.textContent = `Ver 25 m√°s (${baseLabels.length - currentBrandsLimit} restantes)`;
    btn.onclick = () => { currentBrandsLimit += 25; fillBrandsMirrorWithLimit(idBase, idComp, itemsBase, itemsComp); };
  } else { btn.style.display = 'none'; }
}

function renderMonthsChart(baseMonthsArr, compMonthsArr, showComparison = true) {
  const canvas = document.getElementById('monthsChart');
  const ctx = canvas.getContext('2d');
  const DPR = window.devicePixelRatio || 1;
  const cssWidth = canvas.clientWidth;
  const cssHeight = 320; 
  canvas.width = cssWidth * DPR; canvas.height = cssHeight * DPR;
  ctx.scale(DPR, DPR);
  const PADDING = { left: 60, right: 30, top: 20, bottom: 40 };
  const plotW = cssWidth - PADDING.left - PADDING.right;
  const plotH = cssHeight - PADDING.top - PADDING.bottom;
  const labels = MONTHS.map(m => m.slice(3));
  const baseData = labels.map(l => (baseMonthsArr.find(x => x.label === l)?.sum || 0));
  const compData = labels.map(l => (compMonthsArr.find(x => x.label === l)?.sum || 0));
  const maxVal = Math.max(1, ...baseData, ...(showComparison ? compData : [])) * 1.15;
  const getX = i => PADDING.left + (i * plotW / (labels.length - 1));
  const getY = v => PADDING.top + plotH - (v / maxVal) * plotH;
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  ctx.lineWidth = 1;
  for(let i=0; i<=4; i++){
    const y = PADDING.top + plotH - (i * plotH / 4);
    ctx.beginPath(); ctx.moveTo(PADDING.left, y); ctx.lineTo(PADDING.left + plotW, y); ctx.stroke();
    ctx.fillStyle = '#64748b'; ctx.font = '11px sans-serif';
    ctx.fillText(formatInteger(maxVal * i / 4), 5, y + 4);
  }
  const drawArea = (data, color, lightColor) => {
    ctx.beginPath(); ctx.moveTo(getX(0), PADDING.top + plotH);
    for(let i=0; i<data.length; i++) ctx.lineTo(getX(i), getY(data[i]));
    ctx.lineTo(getX(data.length-1), PADDING.top + plotH); ctx.closePath();
    const grad = ctx.createLinearGradient(0, PADDING.top, 0, PADDING.top + plotH);
    grad.addColorStop(0, lightColor); grad.addColorStop(1, 'transparent');
    ctx.fillStyle = grad; ctx.fill();
    ctx.beginPath(); ctx.moveTo(getX(0), getY(data[0]));
    for(let i=1; i<data.length; i++) ctx.lineTo(getX(i), getY(data[i]));
    ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.lineJoin = "round"; ctx.stroke();
  };
  const colorBase = getComputedStyle(document.documentElement).getPropertyValue('--primary-brand').trim();
  const colorComp = getComputedStyle(document.documentElement).getPropertyValue('--secondary-brand').trim();
  if(showComparison) drawArea(compData, colorComp, 'rgba(245, 158, 11, 0.25)');
  drawArea(baseData, colorBase, 'rgba(56, 189, 248, 0.35)');
  ctx.fillStyle = '#94a3b8'; ctx.textAlign = 'center';
  labels.forEach((l, i) => { ctx.fillText(l.slice(0,3), getX(i), cssHeight - 15); });
}

function drawMiniChart(canvasId, baseData, compData, showComp) {
  const canvas = document.getElementById(canvasId);
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const w = canvas.clientWidth, h = canvas.clientHeight;
  canvas.width = w * dpr; canvas.height = h * dpr;
  ctx.scale(dpr, dpr);
  const pad = { t: 15, b: 25, l: 15, r: 15 };
  const pw = w - pad.l - pad.r, ph = h - pad.t - pad.b;
  const max = Math.max(1, ...baseData, ...(showComp ? compData : [])) * 1.1;
  const getX = i => pad.l + (i * pw / 11);
  const getY = v => pad.t + ph - (v / max) * ph;
  ctx.fillStyle = "#64748b"; ctx.font = "9px sans-serif"; ctx.textAlign = "center";
  MONTH_INITIALS.forEach((m, i) => ctx.fillText(m, getX(i), h - 8));
  const drawLine = (data, color) => {
    ctx.beginPath(); ctx.moveTo(getX(0), getY(data[0]));
    for(let i=1; i<12; i++) ctx.lineTo(getX(i), getY(data[i]));
    ctx.strokeStyle = color; ctx.lineWidth = 2.5; ctx.lineJoin = "round"; ctx.stroke();
  };
  if(showComp) drawLine(compData, '#f59e0b');
  drawLine(baseData, '#38bdf8');
}

/* L√≥gica de Estimaci√≥n Final */
function calculateProjection() {
    const today = new Date();
    const currentYear = today.getFullYear().toString();
    const prevYear = (today.getFullYear() - 1).toString();
    const currentMonthIdx = today.getMonth(); 
    const dayOfMonth = today.getDate();
    const daysInMonth = new Date(today.getFullYear(), currentMonthIdx + 1, 0).getDate();
    
    document.getElementById('estYearLabel').textContent = currentYear;

    const site = fSite.value.toLowerCase();
    const prod = fProduct.value.toLowerCase();
    const sec = fSector.value.toLowerCase();
    const area = fArea.value.toLowerCase();
    const adv = fAnunciante.value.toUpperCase();

    const aplicarFiltros = (data) => data.filter(d =>
        (adv === "TODOS" || d.Anunciante === adv) &&
        (site === "todos" || d.Site === site) &&
        (prod === "todos" || d.Product.toLowerCase() === prod) &&
        (sec === "todos" || d.Sector.toLowerCase() === sec) &&
        (area === "todos" || d.Area.toLowerCase() === area)
    );

    const dataCurrentYear = aplicarFiltros(rawData.filter(d => d.A√±o === currentYear));
    const dataPrevYear = aplicarFiltros(rawData.filter(d => d.A√±o === prevYear));

    // Cierre total real del a√±o pasado para comparar porcentajes
    const totalPrevYear = dataPrevYear.reduce((acc, d) => acc + d.ingreso, 0);

    let realHoyTotal = 0;
    let estimacionFinal = 0;
    let tableHTML = "";

    const progFamilies = [
        "programatica display directo", 
        "programatica display indirecto", 
        "video programatico directo", 
        "video programatico indirecto"
    ];

    MONTHS.forEach((m, idx) => {
        const mesDataActual = dataCurrentYear.filter(d => d.Mes === m);
        const mesDataPasado = dataPrevYear.filter(d => d.Mes === m);
        
        const factMesActual = mesDataActual.reduce((acc, d) => acc + d.ingreso, 0);
        const factMesPasado = mesDataPasado.reduce((acc, d) => acc + d.ingreso, 0);

        let mesEstimado = 0;
        let metodo = "";

        if (idx < currentMonthIdx) {
            // MESES CERRADOS: Real de este a√±o
            mesEstimado = factMesActual;
            metodo = "Mes Cerrado (Real)";
            realHoyTotal += factMesActual;
        } 
        else if (idx === currentMonthIdx) {
            // MES EN CURSO: Previsi√≥n lineal + Program√°tica a√±o pasado
            const previsionLineal = (factMesActual / dayOfMonth) * daysInMonth;
            const progMesPasado = mesDataPasado.filter(d => 
                progFamilies.includes(d.Familia.toLowerCase())
            ).reduce((acc, d) => acc + d.ingreso, 0);
            
            mesEstimado = previsionLineal + progMesPasado;
            metodo = "Real + Proy. Lineal + Prog. '25";
            realHoyTotal += factMesActual;
        } 
        else {
            // MESES FUTUROS: Hist√≥rico a√±o anterior + 3%
            mesEstimado = factMesPasado * 1.03;
            metodo = "Hist√≥rico '25 + 3%";
        }

        estimacionFinal += mesEstimado;
        tableHTML += `<tr><td>${m}</td><td>${metodo}</td><td>${formatCurrency(mesEstimado)}</td></tr>`;
    });

    // Calcular badge de crecimiento
    const pctBadge = document.getElementById('valEstPct');
    if (totalPrevYear > 0) {
        const diff = ((estimacionFinal / totalPrevYear) - 1) * 100;
        pctBadge.textContent = (diff > 0 ? "‚Üë " : "‚Üì ") + diff.toFixed(1) + "%";
        pctBadge.className = "pct-badge " + (diff >= 0 ? "pct-pos" : "pct-neg");
    } else {
        pctBadge.textContent = "";
    }

    document.getElementById('valRealHoy').textContent = formatCurrency(realHoyTotal);
    document.getElementById('valEstFinal').textContent = formatCurrency(estimacionFinal);
    document.getElementById('estimateTableBody').innerHTML = tableHTML + 
        `<tr><td>TOTAL PROYECTADO</td><td>Cierre Estimado 31 Dic</td><td>${formatCurrency(estimacionFinal)}</td></tr>`;
}

function render(){
  if (this && this.id !== "brandsToggleBtn") { currentBrandsLimit = 25; }
  const site = fSite.value.toLowerCase(), prod = fProduct.value.toLowerCase(), sec = fSector.value.toLowerCase(),
        y1 = fYear.value, y2 = fYear2.value,
        area = fArea.value.toLowerCase(), adv = fAnunciante.value.toUpperCase();

  const m1 = Array.from(document.getElementById("monthsBase").querySelectorAll("input:checked")).map(c=>c.value);
  const m2 = Array.from(document.getElementById("monthsComp").querySelectorAll("input:checked")).map(c=>c.value);

  document.getElementById('legBase').textContent = y1;
  if(y2 !== "Sin comparar") {
    document.getElementById('legComp').textContent = y2;
    document.getElementById('legCompGroup').style.display = 'flex';
  } else { document.getElementById('legCompGroup').style.display = 'none'; }

  const filter = (y, months) => rawData.filter(d =>
    (y==="Todos" || d.A√±o===y) &&
    (adv==="TODOS" || d.Anunciante===adv) &&
    (site==="todos" || d.Site===site) &&
    (prod==="todos" || d.Product.toLowerCase()===prod) &&
    (sec==="todos" || d.Sector.toLowerCase()===sec) &&
    (area==="todos" || d.Area.toLowerCase()===area) &&
    (months.length === 0 || months.includes(d.Mes))
  );

  const d1 = filter(y1, m1), d2 = y2!=="Sin comparar" ? filter(y2, m2) : [];
  const res1 = calcNetting(d1), res2 = calcNetting(d2);

  totalYear1.textContent = formatCurrency(res1.total);
  totalYear2.textContent = y2!=="Sin comparar" ? formatCurrency(res2.total) : "-";
  const dt=(y2!=="Sin comparar" && res2.total)?Math.round(((res1.total/res2.total)-1)*100):0;
  diffPercent.textContent = y2!=="Sin comparar" ? (dt > 0 ? "+" : "") + dt + "%" : "-";
  diffPercent.className = "value"+(dt<0?" negative":"");
  totalStatsBase.textContent=formatCurrency(res1.total);
  linesStatsBase.textContent=formatInteger(res1.lines);
  avgStatsBase.textContent=formatCurrency(res1.avg);

  if(y2!=="Sin comparar"){
    totalStatsComp.textContent=formatCurrency(res2.total);
    linesStatsComp.textContent=formatInteger(res2.lines);
    avgStatsComp.textContent=formatCurrency(res2.avg);
    const diffAvg=res2.avg>0?Math.round(((res1.avg / res2.avg) - 1) * 100) : 0;
    diffAvgStats.textContent=(diffAvg>0?'+':'')+diffAvg+"%";
    diffAvgStats.className="value"+(diffAvg<0?" negative":"");
  }

  document.getElementById('summaryYearBase').textContent = y1;
  document.getElementById('summaryYearComp').textContent = y2;

  const bBrands = groupSumGeneric(d1, 'Marca'), cBrands = groupSumGeneric(d2, 'Marca');
  const bMonths = groupSumMonths(d1), cMonths = groupSumMonths(d2);
  const bFamilies = groupSumGeneric(d1, 'Familia'), cFamilies = groupSumGeneric(d2, 'Familia');
  const bProds = groupSumGeneric(d1, 'Product'), cProds = groupSumGeneric(d2, 'Product');

  fillBrandsMirrorWithLimit('advBrandsBase', 'advBrandsComp', bBrands, cBrands);
  fillMirrorLists('advMonthsBase', 'advMonthsComp', bMonths, cMonths, true);
  fillMirrorLists('advFamiliesBase', 'advFamiliesComp', bFamilies, cFamilies);
  fillMirrorLists('advProductsBase', 'advProductsComp', bProds, cProds);
  
  if(isUnlocked) {
    const bSales = groupSumGeneric(d1, 'Comercial'), cSales = groupSumGeneric(d2, 'Comercial');
    fillMirrorLists('advSalesBase', 'advSalesComp', bSales, cSales);
  }

  renderMonthsChart(bMonths, cMonths, y2 !== "Sin comparar");

  const getFamEvo = (data) => {
    const map = {}; MONTHS.forEach(m => map[m] = 0);
    data.forEach(d => { if(map[d.Mes] !== undefined) map[d.Mes] += d.ingreso; });
    return MONTHS.map(m => map[m]);
  };

  const drawF = (id, list) => {
    const listLower = list.map(l => l.toLowerCase());
    const data1 = getFamEvo(d1.filter(x => listLower.includes(x.Familia.toLowerCase())));
    const data2 = getFamEvo(d2.filter(x => listLower.includes(x.Familia.toLowerCase())));
    drawMiniChart(id, data1, data2, y2 !== "Sin comparar");
  };

  drawF('chartSpons', ["Sponsorship"]);
  drawF('chartSocial', ["Social Networks"]);
  drawF('chartCurated', ["Curated"]);
  drawF('chartDisplay', ["Display", "Video"]);
  drawF('chartProg', ["Programatica Display Directo", "Programatica Display Indirecto", "Video Programatico Indirecto", "Video Programatico Directo"]);

  calculateProjection();
}
</script>
</body>
</html>