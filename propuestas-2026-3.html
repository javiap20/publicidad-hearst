
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Propuesta Hearst</title>

<!-- Cargas correctas de librer√≠as -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
:root { --bg-dark: #020617; --card-bg: #111827; --text-main: #e5e7eb; --accent: #db2777; --Hearst-blue: #2563eb; --danger: #ef4444; }
body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); padding: 20px; }
.container { max-width: 1300px; margin: auto; }
.card { background: var(--card-bg); border-radius: 12px; padding: 25px; border: 1px solid #1f2937; margin-bottom: 20px; }
h1 { color: #fff; text-align: center; margin-bottom: 30px; }
label { display: block; margin-bottom: 8px; font-weight: bold; color: #94a3b8; font-size: 0.85rem; }
select, input { background: #1f2937; color: #fff; border: 1px solid #374151; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 5px; }
.config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: end; }
.propuesta-bloque { background: #fff; border-radius: 8px; margin-top: 30px; padding: 15px; border-left: 5px solid var(--accent); position: relative; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
.propuesta-bloque h3 { color: #000; margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 8px; font-size: 1.1rem; }
.btn-del-mini { position: absolute; top: 15px; right: 15px; background: var(--danger); color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px; }
table { width: 100%; border-collapse: collapse; color: #000; font-size: 11px; margin-bottom: 10px; }
th { background: #000; color: #fff; padding: 10px; text-align: left; border: 1px solid #333; text-transform: uppercase; }
td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; vertical-align: middle; white-space: pre-line; }
.resumen-global { background: #1e293b; border-radius: 12px; padding: 20px; margin-top: 30px; border: 2px solid var(--Hearst-blue); display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }
.resumen-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }
.resumen-valor { font-size: 1.25rem; color: #fff; font-weight: 800; }
.btn { padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
.btn-add { background: var(--Hearst-blue); color: white; width: 100%; justify-content: center; }
.btn-export { background: var(--accent); color: white; flex: 2; justify-content: center; }
.btn-pdf { background: #10b981; color: white; flex: 1; justify-content: center; }
.btn-clear { background: #4b5563; color: white; flex: 1; justify-content: center; }
.footer-actions { display: flex; gap: 15px; margin-top: 20px; }
.empty-state { text-align: center; color: #4b5563; padding: 40px; border: 2px dashed #1f2937; border-radius: 12px; margin-top: 20px; }
.notas-pie { color: #4b5563; font-size: 10px; margin-top: 10px; font-style: italic; border-top: 1px solid #eee; padding-top: 10px; white-space: pre-line; }
.aviso-comercial { color: #fbbf24; font-size: 10px; font-weight: normal; margin-top: 4px; min-height: 12px; font-style: italic; }
@media print { 
  h1, .card, .btn-del-mini, .footer-actions, .empty-state { display: none !important; } 
  body { background: white !important; color: black !important; padding: 0 !important; } 
  .container { max-width: 100% !important; margin: 0 !important; } 
  .propuesta-bloque { border: 1px solid #eee !important; box-shadow: none !important; page-break-inside: avoid; margin-top: 20px !important; } 
  .resumen-global { background: #f8fafc !important; border: 1px solid #000 !important; color: #000 !important; grid-template-columns: 1fr 1fr 1fr !important; } 
  .resumen-valor { color: #000 !important; } 
  .resumen-label { color: #64748b !important; } 
}
</style>
</head>
<body>
<div class="container">
  <h1>Propuesta Publicitaria Hearst</h1>
  <div class="card">
    <div style="margin-bottom: 20px; border-bottom: 1px solid #374151; padding-bottom: 15px;">
      <label>Marca del Cliente:</label>
      <input type="text" id="marcaCliente" placeholder="Escribe el nombre de la marca aqu√≠..." style="max-width: 400px;">
    </div>
    <div class="config-grid">
      <div>
        <label>Tipo de Propuesta:</label>
        <select id="tipoPropuesta" onchange="actualizarInterfazConfig()">
          <option value="bcd">1. Branded Content Digital</option>
          <option value="bcvd">2. Branded Content V√≠deo Digital</option>
          <option value="print">3. P√°gina Print</option>
          <option value="social">4. Campa√±a Social Paid</option>
          <option value="storyteller">5. Social Paid Storyteller</option>
          <option value="display">6. Campa√±a Display</option>
          <option value="display_story">7. Display Storyteller</option>
          <option value="preroll">8. Campa√±a Preroll</option>
          <option value="bcd_sindicado">9. Branded Content Digital Sindicado</option>
          <option value="social_organic">10. Social Organic</option>
        </select>
      </div>
      <div id="wrapperSoporte">
        <label id="labelSoporte">Soporte/Revista:</label>
        <select id="siteSelect" onchange="verificarOtro()"></select>
        <input type="text" id="siteManual" placeholder="Nombre personalizado..." style="display:none; margin-top:10px;">
      </div>
      <div id="wrapperOrganicFormato" style="display:none">
        <label>Formato Organic:</label>
        <select id="organicFormato">
          <option value="Insider">Insider</option>
          <option value="Hemos probado">Hemos probado</option>
          <option value="Paso a paso">Paso a paso</option>
          <option value="Choice by...">Choice by...</option>
          <option value="Photocall">Photocall</option>
        </select>
      </div>
      <div id="wrapperOrganicPlataforma" style="display:none">
        <label>Plataforma:</label>
        <select id="organicPlataforma">
          <option value="IG Reel">IG Reel</option>
          <option value="TikTok">TikTok</option>
          <option value="IG Reel + TikTok">IG Reel + TikTok</option>
        </select>
      </div>
      <div id="wrapperGarantizado" style="display:none">
        <label>Impresiones (Garantizado):</label>
        <select id="garantizadoImps">
          <option value="100000">100.000</option><option value="200000">200.000</option><option value="300000">300.000</option><option value="400000">400.000</option><option value="500000">500.000</option><option value="600000">600.000</option><option value="700000">700.000</option><option value="800000">800.000</option><option value="900000">900.000</option><option value="1000000">1.000.000</option>
        </select>
      </div>
      <div id="wrapperDesc">
        <label>Descuento Manual (%):</label>
        <input type="number" id="descManual" value="0" step="0.5" min="0" oninput="comprobarLimitesComerciales()">
        <div id="msgAvisoDesc" class="aviso-comercial"></div>
      </div>
      <div id="wrapperCPM" style="display:none">
        <label>CPM (‚Ç¨):</label>
        <input type="number" id="cpmManual" value="12" step="0.1" min="0" oninput="comprobarLimitesComerciales()">
        <div id="msgAvisoCPM" class="aviso-comercial"></div>
      </div>
      <div><button class="btn btn-add" onclick="agregarPropuestaAlListado()">‚ûï A√±adir Propuesta</button></div>
    </div>
  </div>

  <div id="listadoPropuestas"><div class="empty-state">No hay propuestas a√±adidas todav√≠a.</div></div>

  <div id="areaTotales" style="display:none;">
    <div class="resumen-global" id="resumenGlobalContainer"></div>
    <div class="footer-actions">
      <button class="btn btn-clear" onclick="limpiarTodo()">üóëÔ∏è Limpiar</button>
      <button class="btn btn-pdf" onclick="window.print()">üìÑ Generar PDF</button>
      <button class="btn btn-export" onclick="exportarTodoExcel()">üì• Exportar Excel Premium</button>
    </div>
  </div>
</div>

<script>
const dbPrecios = { "bcd": { "elle.es": 12000, "harper's bazaar.es": 10000, "cosmopolitan.es": 10000, "diez minutos.es": 7000, "elle gourmet.es": 8000, "elle decor.es": 7000, "nuevo estilo.es": 7000, "esquire.es": 10000, "fotogramas.es": 8000, "car and driver.es": 7000, "men's health.es": 8000, "women's health.es": 8000, "runner's world.es": 7000 }, "bcvd": { "elle.es": 15000, "harper's bazaar.es": 12000, "cosmopolitan.es": 12000, "diez minutos.es": 9000, "elle gourmet.es": 10000, "elle decor.es": 9000, "nuevo estilo.es": 9000, "esquire.es": 12000, "fotogramas.es": 10000, "car and driver.es": 9000, "men's health.es": 10000, "women's health.es": 10000, "runner's world.es": 9000 }, "organic": { "elle.es": 8500, "harper's bazaar.es": 6000, "cosmopolitan.es": 6000, "diez minutos.es": 4000, "elle gourmet.es": 4000, "elle decor.es": 5000, "nuevo estilo.es": 5000, "esquire.es": 6000, "fotogramas.es": 6000, "car and driver.es": 3000, "men's health.es": 6000, "women's health.es": 6000, "runner's world.es": 6000 } };
const multSites = { "elle.es": { m1: 20, m2: 25 }, "harper's bazaar.es": { m1: 15, m2: 40 }, "cosmopolitan.es": { m1: 7, m2: 40 }, "diez minutos.es": { m1: 20, m2: 40 }, "elle gourmet.es": { m1: 20, m2: 30 }, "elle decor.es": { m1: 12, m2: 40 }, "nuevo estilo.es": { m1: 10, m2: 40 }, "esquire.es": { m1: 12, m2: 45 }, "fotogramas.es": { m1: 15, m2: 40 }, "car and driver.es": { m1: 7, m2: 40 }, "men's health.es": { m1: 7, m2: 45 }, "women's health.es": { m1: 7, m2: 40 }, "runner's world.es": { m1: 7, m2: 40 } };
const dbPrint = { "ELLE": { lectores: 917000, precio: 10000 }, "HARPER'S BAZAAR": { lectores: 372000, precio: 6000 }, "COSMOPOLITAN": { lectores: 1250000, precio: 6000 }, "DIEZ MINUTOS": { lectores: 589000, precio: 3000 }, "ELLE GOURMET": { lectores: 200000, precio: 4000 }, "ELLE DECOR": { lectores: 567000, precio: 5000 }, "NUEVO ESTILO": { lectores: 494000, precio: 5000 }, "ESQUIRE": { lectores: 166000, precio: 6000 }, "FOTOGRAMAS": { lectores: 658000, precio: 4000 }, "CAR AND DRIVER": { lectores: 373000, precio: 3000 }, "MEN'S HEALTH": { lectores: 470000, precio: 4000 }, "RUNNER'S WORLD": { lectores: 368000, precio: 2000 } };
const dbDisplay = { "CIRCUITO FEMENINAS PREMIUM": "Elle, Harper's Bazaar y Cosmopolitan", "CIRCUITO FEMENINAS": "Elle, Bazaar, Cosmopolitan y Diez Minutos", "CIRCUITO DECO": "Elle Decor y Nuevo Estilo", "CIRCUITO MASCULINO HEARST": "Esquire, Fotogramas y Car and driver", "CIRCUITO HEALTHY": "Men's Health, Women's Health y Runner's World" };

function formatNumber(num) { return new Intl.NumberFormat('de-DE').format(num); }
function redondearComercial(valor, tipo) { return tipo === "ctc" ? Math.round(valor / 100) * 100 : Math.round(valor / 10000) * 10000; }

function calcularTotalesPropuesta() {
  let sNeto = 0, sImps = 0, sCTC = 0, sViews = 0;
  document.querySelectorAll(".propuesta-bloque").forEach(b => {
    b.querySelectorAll("table tbody tr").forEach(f => {
      const c = f.querySelectorAll("td");
      if (c.length < 3) return;
      const kpiCell = c.length >= 7 ? c[c.length-3] : null;
      const garantCell = c.length >= 7 ? c[c.length-2] : null;
      const netoCell = c[c.length-1];
      if (kpiCell && !kpiCell.hasAttribute('colspan')) {
        const kpi = kpiCell.innerText.toLowerCase();
        const val = parseInt(garantCell.innerText.replace(/\./g, "")) || 0;
        if (kpi.includes("visuali") || kpi.includes("alcance")) sViews += val;
        else if (kpi.includes("content") || kpi.includes("ctc")) sCTC += val;
        else if (kpi.includes("impresiones") || kpi.includes("lectores")) sImps += val;
      }
      if(netoCell.innerText.includes("‚Ç¨")) sNeto += parseFloat(netoCell.innerText.replace(" ‚Ç¨", "").replace(/\./g, "").replace(",", ".")) || 0;
    });
  });
  const container = document.getElementById("resumenGlobalContainer"); container.innerHTML = "";
  const addTotal = (label, valor, esEuro = false) => { if (valor > 0) container.innerHTML += `<div class="resumen-item"><div class="resumen-label">${label}</div><div class="resumen-valor">${formatNumber(valor)}${esEuro ? ' ‚Ç¨' : ''}</div></div>`; };
  addTotal("Total Impresiones / Lectores", sImps); addTotal("Total CTC", sCTC); addTotal("Total Alcance / Visualizaciones", sViews); addTotal("Total Neto", sNeto, true);
  document.getElementById("areaTotales").style.display = document.querySelectorAll(".propuesta-bloque").length > 0 ? "block" : "none";
}

function comprobarLimitesComerciales() {
  const sel = document.getElementById("tipoPropuesta").value;
  const desc = parseFloat(document.getElementById("descManual").value) || 0;
  const cpm = parseFloat(document.getElementById("cpmManual").value) || 0;
  const msgDesc = document.getElementById("msgAvisoDesc"); const msgCPM = document.getElementById("msgAvisoCPM");
  msgDesc.innerText = ""; msgCPM.innerText = "";
  if (sel === "bcd" && desc > 25) msgDesc.innerText = "‚ö†Ô∏è Excede el descuento m√°ximo recomendado (25%)";
  if (sel === "bcd_sindicado" && desc > 40) msgDesc.innerText = "‚ö†Ô∏è Excede el descuento m√°ximo recomendado (40%)";
  if (["bcvd", "print", "social_organic"].includes(sel) && desc > 0) msgDesc.innerText = "‚ö†Ô∏è Excede el descuento m√°ximo recomendado (0%)";
  if (["social", "preroll"].includes(sel) && cpm < 12) msgCPM.innerText = "‚ö†Ô∏è Tarifa por debajo del CPM m√≠nimo (12‚Ç¨)";
  if (sel === "storyteller" && cpm < 8) msgCPM.innerText = "‚ö†Ô∏è Tarifa por debajo del CPM m√≠nimo (8‚Ç¨)";
  if (sel === "display_story" && cpm < 6) msgCPM.innerText = "‚ö†Ô∏è Tarifa por debajo del CPM m√≠nimo (6‚Ç¨)";
  if (sel === "display" && cpm < 10) msgCPM.innerText = "‚ö†Ô∏è Tarifa por debajo del CPM m√≠nimo (10‚Ç¨)";
}

function actualizarInterfazConfig() {
  const sel = document.getElementById("tipoPropuesta").value;
  const cpm = document.getElementById("cpmManual"); const imp = document.getElementById("garantizadoImps"); const descInput = document.getElementById("descManual");
  document.getElementById("wrapperOrganicFormato").style.display = sel === "social_organic" ? "block" : "none";
  document.getElementById("wrapperOrganicPlataforma").style.display = sel === "social_organic" ? "block" : "none";
  if(["social", "preroll"].includes(sel)) cpm.value = 12; else if(sel === "storyteller") cpm.value = 8; else if(sel === "display_story") cpm.value = 6; else cpm.value = 10;
  descInput.value = (sel === "bcd_sindicado") ? 40 : 0;
  if(["social", "storyteller"].includes(sel)) imp.value = "500000"; else if (["display", "display_story", "preroll"].includes(sel)) imp.value = "400000";
  const esV = ["social", "storyteller", "display", "display_story", "preroll"].includes(sel);
  document.getElementById("wrapperGarantizado").style.display = esV ? "block" : "none";
  document.getElementById("wrapperCPM").style.display = esV ? "block" : "none";
  document.getElementById("wrapperDesc").style.display = esV ? "none" : "block";
  document.getElementById("labelSoporte").innerText = ["display", "display_story", "preroll"].includes(sel) ? "Circuito:" : "Soporte/Revista:";
  let l;
  if (sel === "bcd_sindicado") l = ["diez minutos.es", "men's health.es", "women's health.es", "nuevo estilo.es"];
  else if (["display", "display_story", "preroll"].includes(sel)) l = [...Object.keys(dbDisplay), "OTRO"];
  else if (sel === "print") l = Object.keys(dbPrint);
  else l = Object.keys(dbPrecios.bcd);
  document.getElementById("siteSelect").innerHTML = l.map(s => `<option value="${s}">${s === "OTRO" ? "OTRO (Manual)" : s}</option>`).join("");
  verificarOtro(); comprobarLimitesComerciales();
}

function agregarPropuestaAlListado() {
  const list = document.getElementById("listadoPropuestas"); if(list.querySelector('.empty-state')) list.innerHTML = '';
  const sel = document.getElementById("tipoPropuesta").value; let site = document.getElementById("siteSelect").value;
  if (site === "OTRO") site = document.getElementById("siteManual").value || "Personalizado";
  const desc = parseFloat(document.getElementById("descManual").value) || 0; const cpm = parseFloat(document.getElementById("cpmManual").value);
  const titulo = document.getElementById("tipoPropuesta").options[document.getElementById("tipoPropuesta").selectedIndex].text;
  const div = document.createElement("div"); div.className = "propuesta-bloque";
  div.innerHTML = `<button class="btn-del-mini" onclick="eliminarBloque(this)">‚úñ</button><h3>${titulo} - ${site}</h3>`;
  let tabla = `<table><thead><tr><th>Soporte</th><th>Acci√≥n</th><th>Duraci√≥n</th><th>Formato</th><th>Activ.</th><th>KPI</th><th>${sel === 'social_organic' ? 'Alcance Estimado' : 'Garantizado'}</th><th>Precio Neto</th></tr></thead><tbody>`;
  
  if (sel === "social_organic") {
    const fmt = document.getElementById("organicFormato").value; const plat = document.getElementById("organicPlataforma").value;
    let base = dbPrecios.organic[site] || 0; 
    if(plat === "IG Reel + TikTok") base *= 2; 
    let extra = 0; let pieExtra = "";
    if(fmt === "Paso a paso") { extra = 350; pieExtra = "* Formato Paso a paso de belleza: Extra 350‚Ç¨ (incluye maquillador). No incluye fee de talent/colaboradora. Ideal si lo pone el cliente."; }
    if(fmt === "Hemos probado") { extra = 650; pieExtra = "* Formato Hemos probado: Extra 650‚Ç¨ (incluye maquillaje y colaboradora)"; }
    if(fmt === "Choice by...") { extra = 650; pieExtra = "* Formato Choice by: Extra 650‚Ç¨ (incluye maquillaje y colaboradora)"; }
    
    let subtotal = (base + extra) * (1 - desc/100);
    let accDetalle = `Producci√≥n de video nativo para redes sociales.\nFormato: ${fmt}`;
    
    if(confirm("¬øSer√° un post colaborativo con la marca? (+1.000‚Ç¨)")) {
      subtotal += 1000;
      accDetalle += `\nIncluye: Post colaborativo con la marca & Cesi√≥n de materiales.`;
    }
    if(confirm("¬øDeseas a√±adir un Editorial Native? (+50% del subtotal acumulado)")) {
      subtotal *= 1.5;
      accDetalle += `\nIncluye: Editorial Native (Contenido editorial que acompa√±a al Social Organic amplificando el mensaje en otro medio).`;
    }

    const alcanceEstimado = subtotal * 10;
    tabla += `<tr><td>${site}</td><td>${accDetalle}</td><td>15 d√≠as</td><td>${plat}</td><td>1</td><td>Alcance</td><td>${formatNumber(alcanceEstimado)}</td><td>${formatNumber(subtotal)} ‚Ç¨</td></tr></tbody></table>`;
    if(pieExtra) tabla += `<div class="notas-pie">${pieExtra}</div>`;
  } else if (["social", "storyteller", "display", "display_story", "preroll"].includes(sel)) {
    const imps = parseInt(document.getElementById("garantizadoImps").value); const neto = (imps * cpm) / 1000;
    let acc = ""; let form = "";
    if(sel === "social") { acc = "Paid Post realizado por Hearst\nFormato a definir en funci√≥n de las necesidades de la marca...\n(materiales proporcionados por la marca)"; form = "Social paid"; }
    else if(sel === "storyteller") { acc = "IG Story realizado por Hearst, amplificando la informaci√≥n del BC...\n(materiales proporcionados por la marca)"; form = "Social storyteller"; }
    else if(sel === "display") { acc = "Creatividad realizada por Hearst\n(materiales proporcionados por la marca)"; form = "Display"; }
    else if(sel === "display_story") { acc = "Pieza realizada por Hearst, amplificando la informaci√≥n del BC.\n(materiales proporcionados por la marca)"; form = "Display storyteller"; }
    else if(sel === "preroll") { acc = "Campa√±a PREROLL en los players de v√≠deo de los sites de Hearst seleccionados."; form = "Preroll**"; }
    tabla += `<tr><td>${site}</td><td class="text-center">${acc}</td><td>15 d√≠as</td><td>${form}</td><td>1</td><td>Impresiones</td><td>${formatNumber(imps)}</td><td>${formatNumber(neto)} ‚Ç¨</td></tr></tbody></table>`;
    
    if (["display", "display_story", "preroll"].includes(sel)) {
      const soportesCircuito = dbDisplay[site] || "Soportes seleccionados";
      let notasDisplay = `* Circuito: ${soportesCircuito}\n* Campa√±a gestionada v√≠a program√°tica (Garantizado Hearst). No incluye Data de terceros.`;
      if (sel === "preroll") notasDisplay += `\n** El formato Preroll est√° sujeto a disponibilidad de inventario en los sites seleccionados.`;
      tabla += `<div class="notas-pie">${notasDisplay}</div>`;
    }
  } else if (sel === "print") {
    const d = dbPrint[site]; const neto = d.precio * (1 - desc/100);
    tabla += `<tr><td>${site}</td><td>P√°gina advertorial o publicidad (Material facilitado por cliente)</td><td>N¬∫ Revista TBC</td><td>P√°gina</td><td>1</td><td>Lectores</td><td>${formatNumber(d.lectores)}</td><td>${formatNumber(neto)} ‚Ç¨</td></tr></tbody></table>`;
  } else {
    const tipoPrecios = (sel === "bcd_sindicado") ? "bcd" : sel; const netoBase = dbPrecios[tipoPrecios][site] * (1 - desc/100); const m = multSites[site]; 
    let ctc = redondearComercial((tipoPrecios === "bcvd" ? netoBase * 0.85 : netoBase) / 1.1, "ctc");
    const rows = (sel === "bcvd") ? 
      [{a:"Art√≠culo Branded Content con V√≠deo integrado (Producci√≥n Hearst)", f:"V√≠deo", k:"Click To Content", g: ctc},
       {a:"Tr√°fico desde destacados editoriales en Home y secciones.", f:"Display", k:"Impresiones", g: redondearComercial(ctc*m.m1, "imp")},
       {a:"Amplificaci√≥n en RRSS (FB + IG Story) con enlace al contenido", f:"Social", k:"Impresiones", g: redondearComercial((ctc*m.m2)+(ctc*5), "imp")},
       {a:"RRSS subiendo v√≠deo nativo (FB)", f:"Social", k:"Visualizaciones", g: redondearComercial(ctc*2.5, "imp")}] :
      [{a:"Art√≠culo Branded Content Digital con integraci√≥n de marca y enlace a su site", f:"Branded", k:"Click To Content", g: ctc},
       {a:"Tr√°fico desde destacados editoriales en Home y secciones.", f:"Display", k:"Impresiones", g: redondearComercial(ctc*m.m1, "imp")},
       {a:"Post en Facebook e IG story, con enlace al contenido", f:"Social", k:"Impresiones", g: redondearComercial(ctc*m.m2, "imp")}];
    rows.forEach((r, i) => { 
      tabla += `<tr>${i===0?`<td rowspan="${rows.length}">${site}</td>`:''}
                    <td>${r.a}</td>
                    ${i===0?`<td rowspan="${rows.length}">1 mes</td>`:''}
                    <td>${r.f}</td>
                    ${i===0?`<td rowspan="${rows.length}">1</td>`:''}
                    <td>${r.k}</td>
                    <td>${formatNumber(r.g)}</td>
                    ${i===0?`<td rowspan="${rows.length}">${formatNumber(netoBase)} ‚Ç¨</td>`:''}
               </tr>`; 
    });
    if ((sel === "bcd" || sel === "bcd_sindicado") && confirm("¬øDeseas a√±adir Gastos de Producci√≥n por Parallax (1.500‚Ç¨)?")) 
      tabla += `<tr><td>Gastos de producci√≥n</td><td colspan="6">Producci√≥n de fotos / Gesti√≥n y edici√≥n del Parallax / Contenido interactivo</td><td>1.500 ‚Ç¨</td></tr>`;
    if (sel === "bcvd") {
      let pGastos = parseFloat(prompt("Presupuesto 'Gastos de producci√≥n':", "0")) || 0; 
      let pFee = parseFloat(prompt("Presupuesto 'Fee Modelo/Talent':", "0")) || 0;
      let pCesion = Math.max(pGastos * 0.30, 2500);
      tabla += `<tr><td>Gastos de producci√≥n</td><td colspan="6">Grabaci√≥n de v√≠deo con posproducci√≥n, localizaci√≥n, catering, maquillaje, estilismo‚Ä¶</td><td>${formatNumber(pGastos)} ‚Ç¨</td></tr>
                <tr><td>Fee Modelo/Talent</td><td colspan="6">* Fee aproximado. El importe exacto depender√° de la talent escogida</td><td>${formatNumber(pFee)} ‚Ç¨</td></tr>
                <tr><td>Cesi√≥n de derechos (org√°nico)</td><td colspan="6">Los materiales derivados de la producci√≥n (fotos/v√≠deo) podr√°n ser utilizados por la marca, durante un periodo de 6 meses, en sus medios.</td><td>${formatNumber(pCesion)} ‚Ç¨</td></tr>`;
    }
    tabla += `</tbody></table><div class="notas-pie">* Las Redes Sociales se publicar√°n de forma org√°nica y, eventualmente, se amplificar√° v√≠a paid (data af√≠n)
* Las Redes Sociales de los BC de marcas de bebidas alcoh√≥licas tedr√°n un post org√°nico en el feed de FB, segmentado a mayores de 18 a√±os. No se publicar√° IG Story (META lo proh√≠be). En la amplificaci√≥n paid, si fuese necesario, el post se viralizar√° en los feed de FB e IG. Si META no lo permitiera, lo viralizar√≠amos v√≠a Outbrain (audiencia m√°s afin al soporte Hearst)</div>`;
  }
  div.innerHTML += tabla; list.appendChild(div); calcularTotalesPropuesta(); actualizarInterfazConfig();
}

function eliminarBloque(btn) { btn.parentElement.remove(); if (!document.querySelector(".propuesta-bloque")) document.getElementById("listadoPropuestas").innerHTML = '<div class="empty-state">No hay propuestas.</div>'; calcularTotalesPropuesta(); }
function limpiarTodo() { if(confirm("¬øBorrar todo?")) { document.getElementById("listadoPropuestas").innerHTML = '<div class="empty-state">No hay propuestas.</div>'; calcularTotalesPropuesta(); } }
function verificarOtro() { document.getElementById("siteManual").style.display = document.getElementById("siteSelect").value === "OTRO" ? "block" : "none"; }

/* ============================
   SOLO LA PARTE DEL EXCEL
   ============================ */
async function exportarTodoExcel() {
  try {
    const marca = document.getElementById("marcaCliente").value || "...";
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Propuesta Hearst', { views: [{ showGridLines: false }] });

    // FORMATO POR COLUMNAS: H = n√∫mero; I = moneda ‚Ç¨
    worksheet.getColumn(8).numFmt = '#,##0';
    worksheet.getColumn(9).numFmt = '#,##0" ‚Ç¨"';

    // BORDE SUAVE (gris muy claro) para filas de datos (B..I)
    const lightBorder = { style: 'thin', color: { argb: 'FFDDDDDD' } }; // sube o baja el contraste si quieres
    function aplicarBordeSuaveFila(row, colIni = 2, colFin = 9) {
      for (let c = colIni; c <= colFin; c++) {
        row.getCell(c).border = { top: lightBorder, left: lightBorder, bottom: lightBorder, right: lightBorder };
      }
    }

    const styleHeaderGris = { font: { bold: true }, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD3D3D3' } }, alignment: { horizontal: 'center', vertical: 'middle' } };
    const styleTituloBloque = { font: { bold: true, size: 12 }, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } } };
    const styleTotalNegro = { font: { bold: true, color: { argb: 'FFFFFFFF' } }, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF000000' } }, alignment: { horizontal: 'center', vertical: 'middle' } };

    // Cabecera fija
    worksheet.getCell('B2').value = 'HEARST SPAIN'; worksheet.getCell('B2').font = { bold: true, size: 14 }; worksheet.addRow([]);
    ['Agencia:', 'Anunciante:', 'Campa√±a:', 'Att.'].forEach(label => { let r = worksheet.addRow(['', label]); r.getCell(2).font = { bold: true }; });
    worksheet.addRow([]);
    let optico = worksheet.addRow(['', '√ìPTICO Y KPIs']); optico.getCell(2).font = { bold: true, size: 13, underline: true };
    let brandRow = worksheet.addRow(['', `Propuesta Hearst & ${marca}`]); brandRow.getCell(2).font = { bold: true, size: 11, italic: true }; worksheet.mergeCells(brandRow.number, 2, brandRow.number, 9);
    worksheet.addRow([]);

    // BLOQUES
    document.querySelectorAll(".propuesta-bloque").forEach(b => {
      let rowTit = worksheet.addRow(['', b.querySelector("h3").innerText.toUpperCase()]); rowTit.getCell(2).style = styleTituloBloque; worksheet.addRow([]);
      let hRow = worksheet.addRow(['', 'SOPORTE', 'ACCI√ìN', 'DURACI√ìN', 'FORMATO', 'ACTIV.', 'KPI', 'GARANTIZADO', 'PRECIO NETO']);
      for (let i = 2; i <= 9; i++) hRow.getCell(i).style = styleHeaderGris;

      // Rango de filas de datos para MERGE (por bloque)
      let firstDataRow = null;
      let lastDataRow  = null;

      // Cada fila del tbody
      b.querySelectorAll("table tbody tr").forEach(tr => {
        let cells = tr.querySelectorAll("td"); 
        let rData = [];

        if (cells.length === 8) {
          // Primera fila del grupo (con SOPORTE, DURACI√ìN, ACTIV., PRECIO)
          rData = [
            '', cells[0].innerText, cells[1].innerText, cells[2].innerText, cells[3].innerText,
            cells[4].innerText, cells[5].innerText,
            Number(cells[6].innerText.replace(/\./g, '')),
            Number(cells[7].innerText.replace(" ‚Ç¨", "").replace(/\./g, "").replace(",", "."))
          ];
        } else if (cells.length === 4) {
          // Filas intermedias del grupo (ACCI√ìN, FORMATO, KPI, GARANTIZADO)
          rData = [
            '', '', cells[0].innerText, '', cells[1].innerText, '', cells[2].innerText,
            Number(cells[3].innerText.replace(/\./g, '')), ''
          ];
        } else if (cells.length === 3) {
          // Filas especiales (gastos, fee, cesi√≥n)
          rData = [
            '', cells[0].innerText, cells[1].innerText, '', '', '', '', '',
            Number(cells[2].innerText.replace(" ‚Ç¨", "").replace(/\./g, "").replace(",", "."))
          ];
        } else {
          // Fallback por si algo raro aparece
          rData = Array(9).fill('');
          if (cells[0]) rData[2] = cells[0].innerText;
        }

        let r = worksheet.addRow(rData);
        r.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };

        // En las especiales (3 celdas), tu HTML visualmente ocupa C..H ‚Üí mantenemos ese merge horizontal
        if (cells.length === 3) worksheet.mergeCells(r.number, 3, r.number, 8);

        // Bordes suaves a la fila de datos/especiales
        aplicarBordeSuaveFila(r);

        // Marcar rango del grupo de datos para MERGE de B, D, F, I
        if (cells.length === 8 || cells.length === 4) {
          if (firstDataRow === null) firstDataRow = r.number;
          lastDataRow = r.number;
        }
      });

      // MERGE por bloque: B(2), D(4), F(6), I(9)
      if (firstDataRow !== null && lastDataRow !== null) {
        [2, 4, 6, 9].forEach(col => worksheet.mergeCells(firstDataRow, col, lastDataRow, col));
      }

      // Notas al pie (sin bordes)
      const notes = b.querySelector(".notas-pie"); 
      if (notes) notes.innerText.split('\n').forEach(l => { 
        if (l.trim()){ 
          let nr = worksheet.addRow(['', l.trim()]); 
          nr.getCell(2).font = { italic: true, size: 9 }; 
          worksheet.mergeCells(nr.number, 2, nr.number, 9); 
        } 
      });

      worksheet.addRow([]);
    });

    // TOTAL
    let lastIdx = worksheet.rowCount; 
    let tRow = worksheet.addRow(['', 'TOTAL PROPUESTA', '', '', '', '', '', 0, 0]); 
    tRow.height = 30;
    tRow.getCell(8).value = { formula: `SUM(H10:H${lastIdx})` }; 
    tRow.getCell(9).value = { formula: `SUM(I10:I${lastIdx})` };
    for (let i = 2; i <= 9; i++) {
      tRow.getCell(i).font = styleTotalNegro.font;
      tRow.getCell(i).fill = styleTotalNegro.fill;
      tRow.getCell(i).alignment = styleTotalNegro.alignment;
    }

    // Anchos
    [20, 70, 15, 18, 8, 15, 15, 15].forEach((w, i) => worksheet.getColumn(i + 2).width = w);

    // Guardar
    const buffer = await workbook.xlsx.writeBuffer();
    saveAs(new Blob([buffer]), "Propuesta_Hearst.xlsx");
  } catch (e) {
    alert("Error: " + e.message);
  }
}
actualizarInterfazConfig();
</script>
</body>
</html>
