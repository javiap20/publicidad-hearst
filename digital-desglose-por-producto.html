<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIGITAL - An√°lisis por PRODUCTO</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root {
  --primary-brand: #38bdf8;
  --secondary-brand: #f59e0b;
  --accent-print: #db2777;
  --success: #34d399;
  --danger: #f87171;
  --neutral-gray: #4b5563;
  --bg-dark: #020617;
  --card-bg: #111827;
  --text-main: #e5e7eb;
  --comp: var(--primary-brand);
  --base: var(--secondary-brand);
  --neg: var(--danger);
  --diffColor: #6ee7b7;
  --ok-green: var(--success);
  --totalBg: #1e40af;
  --estimate-bg: #4c1d95; 
  --siteBg: #fef3c7;
  --productoBg: #dbeafe;
  --sectorBg: #fbcfe8;
  --areaBg: #fcd5ce;
  --anuncianteBg: #e9d5ff;
  --title-mes: var(--accent-print);
  --title-site: var(--accent-print);
  --bullet-size: 1.1rem;
  --bullet-indent: 22px;
  --summary-bg: var(--card-bg);
  --summary-border: var(--neutral-gray);
}

body { margin: 0; font-family: 'Inter', Arial, sans-serif; background: linear-gradient(180deg, var(--bg-dark), #0f172a); color: var(--text-main); overflow-y: scroll; }
h1 { text-align: center; font-size: 1.5rem; margin: 20px 0; }
.container{ max-width:1500px; margin:auto; padding:20px; }
.card{ background:rgba(17,24,39,.9); border-radius:14px; padding:18px; margin-bottom:20px; border: 1px solid #1f2937; }
.label-style { font-size: 0.95em; font-weight: bold; margin-bottom: 8px; display: block; }
.filters select, input[type=file]{ background:#1f2933; color:var(--text-main); border:1px solid #374151; padding:8px 10px; border-radius:8px; width: 100%; box-sizing: border-box; }
#loadStatus { margin-top: 10px; font-weight: 600; font-size: 0.85em; }
.filters label{ font-weight:600; margin-right:6px; display:block; margin-top:10px; }
.filtersRow{ display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start; }
.filtersRow div select{ width:210px; font-weight:600; }
#fSite{ background:var(--siteBg); color:#111; }
#fProduct{ background:var(--productoBg); color:#111; }
#fSector{ background:var(--sectorBg); color:#111; }
#fComercial { background: #e0e7ff; color: #111; }
#fArea{ background:var(--areaBg); color:#111; }
#fAnunciante{ background:var(--anuncianteBg); color:#111; }
.checkboxGroup{ display:flex; flex-wrap:wrap; gap:10px; margin-top:5px; }
.checkboxGroup label{ font-size: 0.85em; font-weight:400; color: #cbd5e1; display: flex; align-items: center; gap: 4px; cursor: pointer; }
.totalBlock{ background:var(--totalBg); padding:15px; border-radius:12px; margin-top:10px; }
.totalValues{ display:flex; justify-content:space-around; font-size:18px; }
.totalValues div{text-align:center;}
.totalValues .value{ font-size:22px; font-weight:700; display: block; margin-top: 5px; }
#diffPercent.negative{ color:var(--neg); }
.statsBlock{ display:flex; justify-content:center; border-radius:12px; margin:20px 0; gap:10px; flex-wrap:wrap; }
.subBlock{ border-radius:12px; padding:20px; display:flex; align-items:center; justify-content:center; }
.statsBase{ flex:0 0 450px; background:var(--comp); color:#111; }
.statsDiff{ flex:0 0 300px; background:var(--diffColor); color:#111; }
.statsComp{ flex:0 0 450px; background:var(--base); color:#111; }
.statsValues{ display:flex; justify-content:center; font-size:16px; gap:18px; flex-wrap:wrap; }
.statsValues div{text-align:center;}
.statsValues .value{ font-size:18px; font-weight:700; display:block; margin-top:5px; }
.statsDiff .value.negative{ color:var(--neg); }
.summaryCard{ border:1px solid var(--summary-border); background:var(--summary-bg); border-radius:12px; padding:18px; color:#cbd5e1; }
.summaryCard h2{ margin:0 0 14px 0; font-size:1.15em; color:#fff; }
.summaryGrid{ display:grid; grid-template-columns:repeat(2,minmax(280px,1fr)); gap:18px; }
.summaryHeader{ font-weight:800; color:#fff; border:1px solid #1f2937; border-radius:10px; padding:10px 12px; background:rgba(17,24,39,0.6); }
.summarySection{ background:rgba(2,6,23,0.35); border:1px solid rgba(75,85,99,0.5); border-radius:12px; padding:12px 12px 6px 12px; min-height: 100px; }
.summaryTitle{ font-weight:800; margin:4px 0 10px 0; }
.summaryTitle.mes{ color:var(--title-mes); }
.summaryTitle.site{ color:var(--title-site); }
.itemList { list-style:none; padding:0; margin:0 0 8px 0; }
.itemList li { position:relative; padding-left: var(--bullet-indent); margin:8px 0; color:#e5e7eb; font-weight:400; line-height:1.35; min-height: 1.5rem; }
.itemList li::before{ content:"‚úî"; font-size:var(--bullet-size); position:absolute; left:0; top:0.1rem; }
.itemList li.empty-item::before { content: ""; }
.itemList li.empty-item { color: transparent; }
.itemList .amount{ font-variant-numeric: tabular-nums; font-weight: 700;}
.itemList .pct.neg{ color:var(--neg); }
.itemList .pct.pos{ color:var(--ok-green); }

.chart-legend { display: flex; gap: 20px; margin-bottom: 15px; font-size: 0.9em; font-weight: bold; }
.legend-item { display: flex; align-items: center; gap: 8px; }
.dot-base { width: 14px; height: 14px; background: var(--comp); border-radius: 4px; box-shadow: 0 0 8px var(--comp); }
.dot-comp { width: 14px; height: 14px; background: var(--base); border-radius: 4px; box-shadow: 0 0 8px var(--base); }

.mini-charts-grid { grid-column: 1 / span 2; display: flex; flex-direction: column; gap: 15px; margin: 10px 0; }
.mini-charts-row { display: grid; gap: 10px; }
.row-3-col { grid-template-columns: repeat(3, 1fr); }
.row-2-col { grid-template-columns: repeat(2, 1fr); }
.mini-chart-box { background: rgba(15, 23, 42, 0.5); border: 1px solid #334155; border-radius: 10px; padding: 10px; text-align: center; }
.mini-chart-box h4 { margin: 0 0 8px 0; font-size: 0.85rem; color: var(--accent-print); text-transform: uppercase; }
.mini-canvas { width: 100%; height: 140px; }

/* Nuevo bloque Desglose */
.desglose-section { margin-top: 30px; border-top: 1px solid #374151; padding-top: 20px; }
.site-group-title { background: #1e293b; color: var(--primary-brand); padding: 8px 15px; border-radius: 6px; font-weight: bold; margin: 15px 0 10px 0; display: flex; justify-content: space-between; }
.line-detail { margin-left: 25px; padding: 6px 12px; border-left: 2px solid #38bdf8; margin-bottom: 5px; font-size: 0.9em; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
.line-alert { background: rgba(248, 113, 113, 0.15); border-left-color: var(--danger); }
.badge-familia { background: #334155; color: #cbd5e1; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; text-transform: uppercase; font-weight: 700; }

/* Ajuste para que quepan dos filtros en la cabecera azul */
#siteOnlyBlock .filtersRow { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
#siteOnlyBlock .filtersRow div { width: 100% !important; }

/* Resaltado de l√≠neas negativas en el desglose de reparos */
.line-detail:has(span:contains("-")) {
    border-left: 2px solid var(--neg) !important;
    background: rgba(248, 113, 113, 0.05);
}

</style>
</head>

<body>
<h1>DIGITAL - An√°lisis por <span id="siteTitle">PRODUCTO</span></h1>
<div class="container">
  <div class="card">
    <label class="label-style">Cargar datos (Excel):</label>
    <input type="file" id="fileInput" accept=".json,.xlsx">
    <div id="loadStatus">Esperando archivo...</div>
  </div>

  <div id="filters" class="card filters" style="display:none">
    <div class="filtersRow">
      <div>
        <label class="labelBase" style="color:var(--comp);">A√±o base</label>
        <select id="fYear"></select>
        <div class="checkboxGroup" id="monthsBase"></div>
      </div>
      <div>
        <label class="labelComp" style="color:var(--base);">A√±o comparaci√≥n</label>
        <select id="fYear2"></select>
        <div class="checkboxGroup" id="monthsComp"></div>
      </div>
    </div>
  </div>

  <div id="siteOnlyBlock" class="card filters" style="display:none; border: 2px solid var(--primary-brand); background: rgba(56, 189, 248, 0.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2);">

  <div class="filtersRow">

    <div>

      <label style="color: var(--primary-brand); font-weight: bold; font-size: 1.1em; margin-bottom: 8px; display: block;">üì¶ Seleccionar Producto a analizar</label>

      <select id="fProduct" onchange="render()" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--primary-brand); background-color: #1e293b; color: white; font-size: 1.1em; cursor: pointer;"></select> 

    </div>

    <div>

      <label style="color: var(--secondary-brand); font-weight: bold; font-size: 1.1em; margin-bottom: 8px; display: block;">üîç Tipo de ingreso</label>

      <select id="fTipoFiltro" onchange="render()" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--secondary-brand); background-color: #1e293b; color: white; font-size: 1.1em; cursor: pointer;">

        <option value="todos">Todos</option>

        <option value="cero">L√≠neas a 0‚Ç¨</option>

        <option value="reparos">Reparos</option>

      </select> 

    </div>

  </div>

</div>

  <div id="mainFiltersBlock" class="card filters" style="display:none">
    <div class="filtersRow">
      <div><label>Site</label><select id="fSite" onchange="render()"></select></div>
      <div><label>Comercial</label><select id="fComercial" onchange="render()"></select></div>
      <div><label>Sector</label><select id="fSector" onchange="render()"></select></div>
      <div><label>√Årea</label><select id="fArea" onchange="render()"></select></div>
      <div><label>Anunciante (Por Volumen)</label><select id="fAnunciante" onchange="render()"></select></div>
    </div>
  </div>

  <div id="totalBlock" class="card" style="display:none">
    <div class="totalBlock">
      <div class="totalValues">
        <div>A√±o base<div id="totalYear1" class="value">0‚Ç¨</div></div>
        <div>A√±o comparaci√≥n<div id="totalYear2" class="value">-</div></div>
        <div>% diferencia<div id="diffPercent" class="value">-</div></div>
      </div>
    </div>
  </div>

  <div id="statsBlock" class="statsBlock" style="display:none">
    <div class="subBlock statsBase">
      <div class="statsValues">
        <div>Fact. A√±o Base<div id="totalStatsBase" class="value">0‚Ç¨</div></div>
        <div>N¬∫ l√≠neas<div id="linesStatsBase" class="value">0</div></div>
        <div>Presupuesto medio<div id="avgStatsBase" class="value">0‚Ç¨</div></div>
      </div>
    </div>
    <div class="subBlock statsDiff">
      <div class="statsValues">
        <div>% Crec. Presup. Medio<div id="diffAvgStats" class="value">0%</div></div>
      </div>
    </div>
    <div class="subBlock statsComp">
      <div class="statsValues">
        <div>Fact. A√±o Comparaci√≥n<div id="totalStatsComp" class="value">-</div></div>
        <div>N¬∫ l√≠neas<div id="linesStatsComp" class="value">0</div></div>
        <div>Presupuesto medio<div id="avgStatsComp" class="value">-</div></div>
      </div>
    </div>
  </div>

  <div id="advSummaryCard" class="summaryCard" style="display:none">
    <h2>Resumen</h2>
    <div class="summaryGrid">
      <div class="summaryHeader" style="background:var(--comp); color:#111;">A√±o base: <span id="summaryYearBase">‚Äî</span></div>
      <div class="summaryHeader" style="background:var(--base); color:#111;">A√±o comparaci√≥n: <span id="summaryYearComp">‚Äî</span></div>
      
      <div class="summarySection">
        <div class="summaryTitle site">Site</div>
        <ul id="advSitesBase" class="itemList site"></ul>
      </div>
      <div class="summarySection">
        <div class="summaryTitle site">Site</div>
        <ul id="advSitesComp" class="itemList site"></ul>
      </div>

      <div class="summarySection">
        <div class="summaryTitle mes">Mes</div>
        <ul id="advMonthsBase" class="itemList mes"></ul>
      </div>
      <div class="summarySection">
        <div class="summaryTitle mes">Mes</div>
        <ul id="advMonthsComp" class="itemList mes"></ul>
      </div>

      <div class="summarySection" style="grid-column: 1 / span 2; padding: 15px;">
        <div class="summaryTitle mes" style="margin-bottom: 10px;">Evoluci√≥n mensual (Base vs Comparaci√≥n)</div>
        <div class="chart-legend">
           <div class="legend-item"><div class="dot-base"></div> <span id="legBase">Base</span></div>
           <div id="legCompGroup" class="legend-item" style="display:none"><div class="dot-comp"></div> <span id="legComp">Comp</span></div>
        </div>
        <canvas id="monthsChart" style="width:100%; height:320px; display:block;"></canvas>
      </div>

     
    </div>

    <div class="desglose-section">
        <h2 id="tituloDesglose" style="color: var(--accent-print);">Desglose</h2>
        <div id="desgloseContainer"></div>
    </div>
  </div>
</div>

<script>
const excelUrl = "PRODUCCION%20DIGITAL.xlsx";
const MONTHS = ["01 Enero","02 Febrero","03 Marzo","04 Abril","05 Mayo","06 Junio","07 Julio","08 Agosto","09 Septiembre","10 Octubre","11 Noviembre","12 Diciembre"];
const MONTH_INITIALS = ["E", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D"];
let rawData = [];

// Referencias de presupuesto medio
const REF_STANDARD = { "caranddriver": 5250, "cosmopolitan": 7500, "diezminutos": 5250, "elle": 9000, "elledecor": 5250, "esquire": 7500, "fotogramas": 6000, "harpersbazaar": 7500, "menshealth": 6000, "micasarevista": 5250, "nuevo-estilo": 5250, "runnersworld": 5250, "womenshealthmag": 6000 };
const REF_VIDEO = { "caranddriver": 7600, "cosmopolitan": 10400, "diezminutos": 7600, "elle": 12000, "elledecor": 7600, "esquire": 10400, "fotogramas": 8400, "harpersbazaar": 10400, "menshealth": 8400, "micasarevista": 7600, "nuevo-estilo": 7600, "runnersworld": 7600, "womenshealthmag": 8400 };

function limpiarSite(url) {
  if(!url) return "Desconocido";
  return url.replace(/^(www\.)?/, '').split('.')[0];
}

window.addEventListener("DOMContentLoaded", () => {
  const statusEl = document.getElementById("loadStatus");
  fetch(excelUrl)
    .then(resp => resp.ok ? resp.arrayBuffer() : Promise.reject())
    .then(buf => {
      const wb = XLSX.read(buf, { type: "array" });
      init(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" }));
      statusEl.innerText = "‚úÖ Archivo cargado autom√°ticamente";
      statusEl.style.color = "var(--ok-green)";
    })
    .catch(() => { statusEl.innerText = "‚ö†Ô∏è Selecciona el Excel manualmente."; });
});

function toTitleCase(str) { if(!str) return ""; return str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); }
function cleanSector(str) { if(!str) return ""; return toTitleCase(str.replace(/^[0-9* ]+/, "")); }
function num(v){ if(v==null) return 0; if(typeof v === 'number') return v; const s = String(v).replace(/\u00A0/g," ").replace(/‚Ç¨/g,"").replace(/\s/g,"").replace(/\./g,"").replace(/,/g,"."); const n = Number(s); return Number.isFinite(n) ? n : 0; }
const currencyFormatter = new Intl.NumberFormat('es-ES', { useGrouping: true, minimumFractionDigits: 0, maximumFractionDigits: 0 });
function formatCurrency(n){ return currencyFormatter.format(Math.round(n||0))+'‚Ç¨'; }
function formatInteger(n){ return new Intl.NumberFormat('es-ES').format(Math.round(n||0)); }

fileInput.onchange = e => {
  const f = e.target.files[0];
  const r = new FileReader();
  r.onload = ev => {
    const data = new Uint8Array(ev.target.result);
    const wb = XLSX.read(data, {type:"array"});
    init(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" }));
  };
  r.readAsArrayBuffer(f);
};

function init(data){
  rawData = data.map(d => ({
    ingreso: num(d["Imp.Neto a Comisionar"]),
    A√±o: String(d["A√±o inserci√≥n"] || "").trim(),
    Mes: MONTHS.find(m => m.startsWith(String(d["Mes inserci√≥n"]).trim().substring(0,2))) || "",
    Site: String(d["Publicaci√≥n"] || "").trim().toLowerCase(),
    Product: toTitleCase(String(d["Producto"] || "").trim()),
    Sector: cleanSector(String(d["Sector"] || "")),
    Comercial: toTitleCase(String(d["Comercial"] || "").trim()),
    Area: toTitleCase(String(d["√ÅREAS"] || "").trim()),
    Anunciante: String(d["Anunciante"] || "SIN ANUNCIANTE").trim().toUpperCase(),
    Marca: toTitleCase(String(d["Marca"] || "").trim()),
    Familia: toTitleCase(String(d["Familia"] || "").trim())
  })).filter(d => d.A√±o !== "");

  const populate = (id, arr) => {
    const el = document.getElementById(id);
    if(!el) return;
    el.innerHTML = "<option>Todos</option>" + [...new Set(arr.filter(Boolean))].sort().map(v=>`<option>${v}</option>`).join("");
  };

  const advSums = {};
  rawData.forEach(d => { if(d.Anunciante) advSums[d.Anunciante] = (advSums[d.Anunciante] || 0) + d.ingreso; });
  const sortedAdvs = Object.keys(advSums).sort((a,b) => advSums[b] - advSums[a]);
  fAnunciante.innerHTML = "<option>Todos</option>" + sortedAdvs.map(v => `<option>${v}</option>`).join("");

  populate("fComercial", rawData.map(d => d.Comercial)); 
  populate("fSite", rawData.map(d => d.Site));
  populate("fProduct", rawData.map(d => d.Product));
  populate("fSector", rawData.map(d => d.Sector));
  populate("fArea", rawData.map(d => d.Area));

  const years = [...new Set(rawData.map(d=>d.A√±o))].sort().reverse();
  fYear.innerHTML = "<option>Todos</option>" + years.map(y=>`<option>${y}</option>`).join("");
  fYear2.innerHTML = "<option>Sin comparar</option>" + years.map(y=>`<option>${y}</option>`).join("");

  document.getElementById("monthsBase").innerHTML = MONTHS.map(m=>`<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");
  document.getElementById("monthsComp").innerHTML = MONTHS.map(m=>`<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");

  [fAnunciante, fSite, fProduct, fSector, fYear, fYear2, fArea, fComercial].forEach(el => { if(el) el.onchange = render; });
  ["mainFiltersBlock", "siteOnlyBlock", "filters", "totalBlock", "advSummaryCard"].forEach(id => {
    const block = document.getElementById(id);
    if(block) block.style.display = "block";
  });
  document.getElementById("statsBlock").style.display = "flex";

  // SELECCIONAR BRANDED CONTENT POR DEFECTO
  const options = Array.from(fProduct.options);
  const target = options.find(o => o.text === "Branded Content");
  if(target) fProduct.value = target.text;

  render();
}

function calcNetting(data) {
  const totalFact = data.reduce((acc, b) => acc + b.ingreso, 0);
  const groups = {};
  data.forEach(d => { if (!groups[d.Anunciante]) groups[d.Anunciante] = []; groups[d.Anunciante].push(d.ingreso); });
  let lines = 0;
  Object.values(groups).forEach(pool => {
    let filteredPool = pool.filter(v => v !== 0).sort((a, b) => Math.abs(a) - Math.abs(b));
    while (filteredPool.length > 0) {
      let cur = filteredPool.shift();
      let idx = filteredPool.findIndex(v => v === -cur);
      if (idx !== -1) filteredPool.splice(idx, 1);
      else if (cur > 0) lines++;
    }
  });
  return { total: totalFact, lines, avg: lines ? totalFact / lines : 0 };
}

function groupSumGeneric(data, keyField) {
  const map = new Map();
  data.forEach(d => { 
    const k = d[keyField] || "Desconocido"; 
    if (!map.has(k)) map.set(k, { sum: 0 });
    map.get(k).sum += d.ingreso;
  });
  return Array.from(map.entries()).map(([label, info]) => ({ label, sum: info.sum })).sort((a, b) => b.sum - a.sum);
}

function groupSumMonths(data) {
  const map = new Map();
  data.forEach(d => { if(d.Mes) map.set(d.Mes, (map.get(d.Mes) || 0) + d.ingreso); });
  return MONTHS.map(m => ({ label: m.slice(3), sum: map.get(m) || 0 }));
}

function fillMirrorLists(idBase, idComp, itemsBase, itemsComp, isMonth = false) {
  const ulBase = document.getElementById(idBase);
  const ulComp = document.getElementById(idComp);
  if(!ulBase || !ulComp) return;
  ulBase.innerHTML = ""; ulComp.innerHTML = "";
  const allLabels = isMonth ? MONTHS.map(m => m.slice(3)) : [...new Set([...itemsBase.map(i => i.label), ...itemsComp.map(i => i.label)])];
  allLabels.forEach(label => {
    const dataBase = itemsBase.find(i => i.label === label);
    const dataComp = itemsComp.find(i => i.label === label);
    if(!isMonth && !dataBase && !dataComp) return;
    const liB = document.createElement('li');
    if (dataBase) {
      let content = `${dataBase.label} ‚Äî <span class="amount">${formatCurrency(dataBase.sum)}</span>`;
      if (dataComp && dataComp.sum > 0) {
        const pct = Math.round(((dataBase.sum / dataComp.sum) - 1) * 100);
        content += ` ‚Äî <span class="pct ${pct < 0 ? 'neg' : 'pos'}">${pct > 0 ? '+' : ''}${pct}%</span>`;
      }
      liB.innerHTML = content;
    } else { liB.className = "empty-item"; liB.innerHTML = `${label} ‚Äî 0‚Ç¨`; }
    ulBase.appendChild(liB);
    const liC = document.createElement('li');
    if (dataComp) liC.innerHTML = `${dataComp.label} ‚Äî <span class="amount">${formatCurrency(dataComp.sum)}</span>`;
    else { liC.className = "empty-item"; liC.innerHTML = `${label} ‚Äî 0‚Ç¨`; }
    ulComp.appendChild(liC);
  });
}

function renderMonthsChart(baseMonthsArr, compMonthsArr, showComparison = true) {
  const canvas = document.getElementById('monthsChart');
  const ctx = canvas.getContext('2d');
  const DPR = window.devicePixelRatio || 1;
  const cssWidth = canvas.clientWidth, cssHeight = 320; 
  canvas.width = cssWidth * DPR; canvas.height = cssHeight * DPR;
  ctx.scale(DPR, DPR);
  const PADDING = { left: 60, right: 30, top: 20, bottom: 40 };
  const plotW = cssWidth - PADDING.left - PADDING.right, plotH = cssHeight - PADDING.top - PADDING.bottom;
  const labels = MONTHS.map(m => m.slice(3));
  const baseData = labels.map(l => (baseMonthsArr.find(x => x.label === l)?.sum || 0));
  const compData = labels.map(l => (compMonthsArr.find(x => x.label === l)?.sum || 0));
  const maxVal = Math.max(1, ...baseData, ...(showComparison ? compData : [])) * 1.15;
  const getX = i => PADDING.left + (i * plotW / (labels.length - 1));
  const getY = v => PADDING.top + plotH - (v / maxVal) * plotH;
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  for(let i=0; i<=4; i++){
    const y = PADDING.top + plotH - (i * plotH / 4);
    ctx.beginPath(); ctx.moveTo(PADDING.left, y); ctx.lineTo(PADDING.left + plotW, y); ctx.stroke();
    ctx.fillStyle = '#64748b'; ctx.font = '11px sans-serif';
    ctx.fillText(formatInteger(maxVal * i / 4), 5, y + 4);
  }
  const drawArea = (data, color, lightColor) => {
    ctx.beginPath(); ctx.moveTo(getX(0), PADDING.top + plotH);
    for(let i=0; i<data.length; i++) ctx.lineTo(getX(i), getY(data[i]));
    ctx.lineTo(getX(data.length-1), PADDING.top + plotH); ctx.closePath();
    const grad = ctx.createLinearGradient(0, PADDING.top, 0, PADDING.top + plotH);
    grad.addColorStop(0, lightColor); grad.addColorStop(1, 'transparent');
    ctx.fillStyle = grad; ctx.fill();
    ctx.beginPath(); ctx.moveTo(getX(0), getY(data[0]));
    for(let i=1; i<data.length; i++) ctx.lineTo(getX(i), getY(data[i]));
    ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.stroke();
  };
  const colorBase = getComputedStyle(document.documentElement).getPropertyValue('--primary-brand').trim();
  const colorComp = getComputedStyle(document.documentElement).getPropertyValue('--secondary-brand').trim();
  if(showComparison) drawArea(compData, colorComp, 'rgba(245, 158, 11, 0.25)');
  drawArea(baseData, colorBase, 'rgba(56, 189, 248, 0.35)');
  ctx.fillStyle = '#94a3b8'; ctx.textAlign = 'center';
  labels.forEach((l, i) => { ctx.fillText(l.slice(0,3), getX(i), cssHeight - 15); });
}

function drawMiniChart(canvasId, baseData, compData, showComp) {
  const canvas = document.getElementById(canvasId);
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const w = canvas.clientWidth, h = canvas.clientHeight;
  canvas.width = w * dpr; canvas.height = h * dpr;
  ctx.scale(dpr, dpr);
  const pad = { t: 15, b: 25, l: 15, r: 15 };
  const pw = w - pad.l - pad.r, ph = h - pad.t - pad.b;
  const max = Math.max(1, ...baseData, ...(showComp ? compData : [])) * 1.1;
  const getX = i => pad.l + (i * pw / 11);
  const getY = v => pad.t + ph - (v / max) * ph;
  ctx.fillStyle = "#64748b"; ctx.font = "9px sans-serif"; ctx.textAlign = "center";
  MONTH_INITIALS.forEach((m, i) => ctx.fillText(m, getX(i), h - 8));
  const drawLine = (data, color) => {
    ctx.beginPath(); ctx.moveTo(getX(0), getY(data[0]));
    for(let i=1; i<12; i++) ctx.lineTo(getX(i), getY(data[i]));
    ctx.strokeStyle = color; ctx.lineWidth = 2.5; ctx.stroke();
  };
  if(showComp) drawLine(compData, '#f59e0b');
  drawLine(baseData, '#38bdf8');
}

function render(){
  const prodText = fProduct.value;
  const prod = prodText.toLowerCase();
  
  const tituloDesglose = document.getElementById('tituloDesglose');
  if(tituloDesglose) tituloDesglose.textContent = `Desglose de ${prodText}`;

  const selComercial = fComercial.value;
  const site = fSite.value.toLowerCase(), sec = fSector.value.toLowerCase(),
        y1 = fYear.value, y2 = fYear2.value,
        area = fArea.value.toLowerCase(), adv = fAnunciante.value.toUpperCase();
        
  const m1 = Array.from(document.getElementById("monthsBase").querySelectorAll("input:checked")).map(c=>c.value);
  const m2 = Array.from(document.getElementById("monthsComp").querySelectorAll("input:checked")).map(c=>c.value);

  document.getElementById('legBase').textContent = y1;
  if(y2 !== "Sin comparar") {
    document.getElementById('legComp').textContent = y2;
    document.getElementById('legCompGroup').style.display = 'flex';
  } else document.getElementById('legCompGroup').style.display = 'none';

  const filter = (y, months) => rawData.filter(d =>
    (y==="Todos" || d.A√±o===y) &&
    (prod==="todos" || d.Product.toLowerCase()===prod) &&
    (selComercial === "Todos" || d.Comercial === selComercial) &&
    (adv==="TODOS" || d.Anunciante===adv) &&
    (site==="todos" || d.Site===site) &&
    (sec==="todos" || d.Sector.toLowerCase()===sec) &&
    (area==="todos" || d.Area.toLowerCase()===area) &&
    (months.length === 0 || months.includes(d.Mes))
  );

  // --- BLOQUE DE FILTRADO ACTUALIZADO ---
  
  let d1 = filter(y1, m1);
  let d2 = y2 !== "Sin comparar" ? filter(y2, m2) : [];

  const tipoFiltro = document.getElementById('fTipoFiltro').value;
  
  const aplicarTipo = (data) => {
    if (tipoFiltro === "cero") return data.filter(d => d.ingreso === 0);
    
    if (tipoFiltro === "reparos") {
      const result = [];
      const usedIndices = new Set();

      data.forEach((item, i) => {
        if (usedIndices.has(i) || item.ingreso === 0) return;

        // Buscamos una pareja exacta que no haya sido usada todav√≠a
        const pairIndex = data.findIndex((other, j) => 
          i !== j && 
          !usedIndices.has(j) &&
          item.Site === other.Site &&
          item.Anunciante === other.Anunciante &&
          item.Marca === other.Marca &&
          item.ingreso === -other.ingreso
        );

        if (pairIndex !== -1) {
          usedIndices.add(i);
          usedIndices.add(pairIndex);
          result.push(item);
          result.push(data[pairIndex]);
        }
      });
      return result; // Solo devuelve los que tienen pareja confirmada 1 a 1
    }
    return data;
  };

  d1 = aplicarTipo(d1);
  d2 = aplicarTipo(d2);

  const res1 = calcNetting(d1), res2 = calcNetting(d2);
  // --- FIN DEL BLOQUE ---

  totalYear1.textContent = formatCurrency(res1.total);
  totalYear2.textContent = y2!=="Sin comparar" ? formatCurrency(res2.total) : "-";
  const dt=(y2!=="Sin comparar" && res2.total)?Math.round(((res1.total/res2.total)-1)*100):0;
  diffPercent.textContent = y2!=="Sin comparar" ? (dt > 0 ? "+" : "") + dt + "%" : "-";
  diffPercent.className = "value"+(dt<0?" negative":"");
  totalStatsBase.textContent=formatCurrency(res1.total);
  linesStatsBase.textContent=formatInteger(res1.lines);
  avgStatsBase.textContent=formatCurrency(res1.avg);

  if(y2!=="Sin comparar"){
    totalStatsComp.textContent=formatCurrency(res2.total);
    linesStatsComp.textContent=formatInteger(res2.lines);
    avgStatsComp.textContent=formatCurrency(res2.avg);
    const diffAvg=res2.avg>0?Math.round(((res1.avg / res2.avg) - 1) * 100) : 0;
    diffAvgStats.textContent=(diffAvg>0?'+':'')+diffAvg+"%";
    diffAvgStats.className="value"+(diffAvg<0?" negative":"");
  }

  document.getElementById('summaryYearBase').textContent = y1;
  document.getElementById('summaryYearComp').textContent = y2;

  const bMonths = groupSumMonths(d1), cMonths = groupSumMonths(d2);
  const bSites = groupSumGeneric(d1, 'Site'), cSites = groupSumGeneric(d2, 'Site');

  fillMirrorLists('advSitesBase', 'advSitesComp', bSites, cSites);
  fillMirrorLists('advMonthsBase', 'advMonthsComp', bMonths, cMonths, true);
  
  renderMonthsChart(bMonths, cMonths, y2 !== "Sin comparar");

  const getFamEvo = (data) => {
    const map = {}; MONTHS.forEach(m => map[m] = 0);
    data.forEach(d => { if(map[d.Mes] !== undefined) map[d.Mes] += d.ingreso; });
    return MONTHS.map(m => map[m]);
  };

  const drawF = (id, list) => {
    const listLower = list.map(l => l.toLowerCase());
    const data1 = getFamEvo(d1.filter(x => listLower.includes(x.Familia.toLowerCase())));
    const data2 = getFamEvo(d2.filter(x => listLower.includes(x.Familia.toLowerCase())));
    drawMiniChart(id, data1, data2, y2 !== "Sin comparar");
  };

 
  renderDesglose(d1);
}

function renderDesglose(data) {
    const container = document.getElementById('desgloseContainer');
    container.innerHTML = "";
    if (data.length === 0) { container.innerHTML = "<p>Sin datos para el producto seleccionado.</p>"; return; }

    const tipoFiltro = document.getElementById('fTipoFiltro').value;
    const grouped = {};
    
    data.forEach(d => {
        const s = limpiarSite(d.Site);
        if (!grouped[s]) grouped[s] = { total: 0, items: [] };
        grouped[s].total += d.ingreso;
        grouped[s].items.push(d);
    });

    const sortedSites = Object.keys(grouped).sort((a,b) => grouped[b].total - grouped[a].total);

    sortedSites.forEach(sName => {
        const groupDiv = document.createElement('div');
        groupDiv.innerHTML = `<div class="site-group-title"><span>${sName.toUpperCase()}</span> <span>${formatCurrency(grouped[sName].total)}</span></div>`;
        
        // --- CAMBIO QUIR√öRGICO AQU√ç ---
        // Si NO estamos en reparos, ordenamos por importe (como siempre).
        // Si ESTAMOS en reparos, dejamos el orden que viene del filtro (que ya van por parejas).
        const itemsAMostrar = tipoFiltro === "reparos" 
            ? grouped[sName].items 
            : grouped[sName].items.sort((a, b) => b.ingreso - a.ingreso);

        itemsAMostrar.forEach(item => {
            const prodLow = item.Product.toLowerCase();
            const esBrandedFam = ["branded content", "branded content video", "branded content syndicated", "curated"].includes(prodLow);
            let alert = false;
            
            if (esBrandedFam) {
                const ref = prodLow.includes("video") ? REF_VIDEO[sName] : REF_STANDARD[sName];
                if (ref && item.ingreso < ref && item.ingreso > 0) alert = true; 
            }

            const line = document.createElement('div');
            // Si el ingreso es negativo, le damos un estilo visual diferente para identificarlo r√°pido
            const esNegativo = item.ingreso < 0;
            line.className = `line-detail ${alert ? 'line-alert' : ''}`;
            if (esNegativo) {
                line.style.borderLeftColor = "var(--danger)";
                line.style.background = "rgba(248, 113, 113, 0.05)";
            }

            line.innerHTML = `
                <span class="badge-familia">${item.Familia}</span>
                <span>${alert ? '‚ö†Ô∏è ' : ''}${esNegativo ? '‚Ü©Ô∏è REPARO - ' : ''}Marca: <b>${item.Marca}</b></span>
                <span style="opacity:0.7">Anunciante: ${item.Anunciante}</span>
                <span style="margin-left:auto; font-weight:bold; color: ${esNegativo ? 'var(--danger)' : 'inherit'}">${formatCurrency(item.ingreso)}</span>
            `;
            groupDiv.appendChild(line);
        });
        container.appendChild(groupDiv);
    });
}

</script>
</body>
</html>